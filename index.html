<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Acuapon칤a OPS: Lab M칩vil</title>
    <!-- Iconos de Google -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --primary: #00f2ff;
            --secondary: #004d40;
            --bg: #121212;
            --glass: rgba(255, 255, 255, 0.1);
            --danger: #ff5252;
            --success: #69f0ae;
        }
        body {
            font-family: 'Courier New', monospace;
            background-color: var(--bg);
            color: white;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* UI Elements */
        .screen {
            flex: 1;
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.5s;
        }
        .active { display: flex; }
        
        h1, h2 { text-shadow: 0 0 10px var(--primary); text-align: center; }
        
        .hud-panel {
            background: var(--glass);
            border: 1px solid var(--primary);
            border-radius: 10px;
            padding: 15px;
            width: 90%;
            max-width: 400px;
            margin-bottom: 20px;
            backdrop-filter: blur(5px);
        }

        .btn {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 15px 30px;
            font-size: 1.2rem;
            margin: 10px;
            cursor: pointer;
            border-radius: 5px;
            transition: 0.3s;
            text-transform: uppercase;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .btn:active { background: var(--primary); color: black; }
        
        .notebook-instruction {
            border-left: 4px solid #ffeb3b;
            background: rgba(255, 235, 59, 0.1);
            padding: 10px;
            font-size: 0.9rem;
            text-align: left;
            margin: 10px 0;
        }

        /* Camera View */
        #camera-feed {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid var(--primary);
            display: none;
        }

        /* Microphone Visualizer */
        #mic-visualizer {
            width: 100%;
            height: 50px;
            background: #333;
            margin-top: 10px;
            border-radius: 25px;
            overflow: hidden;
            position: relative;
        }
        #mic-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--danger));
            transition: width 0.1s;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Module Specifics */
        .status-badge {
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.8rem;
        }
        .critical { background: var(--danger); color: black; }
        .stable { background: var(--success); color: black; }

    </style>
</head>
<body>

    <!-- PANTALLA DE INICIO -->
    <div id="screen-home" class="screen active">
        <span class="material-icons" style="font-size: 64px; color: var(--primary);">science</span>
        <h1>ACUAPON칈A OPS</h1>
        <p>Sistema de Gesti칩n Remota</p>
        <p style="font-size: 0.8rem; color: #aaa;">Requiere: C치mara, Micr칩fono y Libreta de Campo</p>
        <button class="btn" onclick="startGame()">Iniciar Sistema</button>
    </div>

    <!-- MEN칔 DE EQUIPOS -->
    <div id="screen-menu" class="screen">
        <h2>PANEL DE CONTROL</h2>
        <div class="hud-panel">
            <p>Selecciona tu especialidad para restaurar el sistema:</p>
            <button class="btn" onclick="loadModule('infra')">
                <span class="material-icons">build</span> Infraestructura
            </button>
            <button class="btn" onclick="loadModule('plants')">
                <span class="material-icons">eco</span> Plantas
            </button>
            <button class="btn" onclick="loadModule('water')">
                <span class="material-icons">water_drop</span> Agua
            </button>
            <button class="btn" onclick="loadModule('fish')">
                <span class="material-icons">set_meal</span> Peces
            </button>
        </div>
    </div>

    <!-- M칍DULO INFRAESTRUCTURA (MICR칍FONO) -->
    <div id="screen-infra" class="screen">
        <div class="hud-panel">
            <h3>游댢 Mantenimiento de Bombas</h3>
            <span class="status-badge critical">OBSTRUCCI칍N DETECTADA</span>
            
            <div class="notebook-instruction">
                <strong>LIBRETA:</strong> Investiga c칩mo funciona un sif칩n de campana. Dibuja el diagrama de flujo y escribe "Mantenimiento Preventivo" en tu bit치cora.
            </div>

            <p>El sif칩n tiene una burbuja de aire bloqueando el flujo. 춰Usa el micr칩fono!</p>
            <p><strong>Instrucci칩n:</strong> Sopla fuerte en el micr칩fono de tu celular para purgar la tuber칤a.</p>
            
            <div id="mic-visualizer"><div id="mic-bar"></div></div>
            <p id="mic-status">Presi칩n: 0%</p>
            
            <button class="btn" id="btn-mic-start" onclick="initMic()">Activar Sensor de Aire</button>
        </div>
        <button class="btn" onclick="goHome()">Volver</button>
    </div>

    <!-- M칍DULO PLANTAS (C츼MARA) -->
    <div id="screen-plants" class="screen">
        <div class="hud-panel">
            <h3>游 Diagn칩stico Vegetal</h3>
            <span class="status-badge critical">DEFICIENCIA DETECTADA</span>

            <div class="notebook-instruction">
                <strong>LIBRETA:</strong> Investiga las se침ales de falta de Hierro en hojas. Dibuja una hoja con clorosis en tu libreta y etiqu칠tala.
            </div>

            <p>Sube la evidencia visual a la base de datos central.</p>
            
            <video id="camera-feed" autoplay playsinline></video>
            <canvas id="camera-canvas" style="display:none;"></canvas>
            <img id="photo-preview" style="display:none; width: 100%; border-radius: 10px; margin-top: 10px;">

            <button class="btn" id="btn-cam" onclick="initCamera()">游닞 Escanear Libreta</button>
            <button class="btn" id="btn-capture" style="display:none;" onclick="capturePhoto()">Capturar</button>
            <button class="btn" id="btn-submit-plant" style="display:none;" onclick="validatePlant()">Enviar An치lisis</button>
        </div>
        <button class="btn" onclick="goHome()">Volver</button>
    </div>

    <!-- M칍DULO AGUA (L칍GICA) -->
    <div id="screen-water" class="screen">
        <div class="hud-panel">
            <h3>游눦 Qu칤mica del Agua</h3>
            <span class="status-badge critical">ALERTA DE AMONIO</span>

            <div class="notebook-instruction">
                <strong>LIBRETA:</strong> Escribe la tabla de par치metros ideales: pH, Temp, Nitratos para Tilapia.
            </div>

            <p>Calibrar sensores. Selecciona el rango de pH seguro para la mayor칤a de sistemas acuap칩nicos:</p>
            
            <select id="ph-selector" style="width: 100%; padding: 10px; margin: 10px 0; background: #333; color: white;">
                <option value="0">Seleccionar...</option>
                <option value="4">츼cido (4.0 - 5.0)</option>
                <option value="7">Neutro/Ideal (6.8 - 7.2)</option>
                <option value="9">Alcalino (8.5 - 9.0)</option>
            </select>

            <button class="btn" onclick="checkWater()">Calibrar</button>
        </div>
        <button class="btn" onclick="goHome()">Volver</button>
    </div>

     <!-- M칍DULO PECES (SONIDO) -->
     <div id="screen-fish" class="screen">
        <div class="hud-panel">
            <h3>游 Monitor de Tanque</h3>
            <p>Escucha el sonido del tanque. 쮻etectas anomal칤as?</p>
            
            <button class="btn" onclick="playSound()">游댉 Reproducir Audio del Tanque</button>
            
            <div class="notebook-instruction">
                <strong>LIBRETA:</strong> Investiga: 쮺u치nta prote칤na necesita un alev칤n vs un adulto? An칩talo.
            </div>

            <p>Diagn칩stico:</p>
            <button class="btn" onclick="alert('Incorrecto. El sonido es de agua fluyendo, lo cual es bueno. El problema es la comida.')">Bomba Rota</button>
            <button class="btn" onclick="finishFish()">Falta de Ox칤geno</button>
        </div>
        <button class="btn" onclick="goHome()">Volver</button>
    </div>

    <script>
        // --- NAVEGACI칍N ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            stopMedia(); // Detener c치mara/mic al cambiar de pantalla
        }

        function startGame() { showScreen('screen-menu'); }
        function goHome() { showScreen('screen-menu'); }
        function loadModule(module) { showScreen('screen-' + module); }

        function stopMedia() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
        }

        let currentStream = null;

        // --- M칍DULO INFRAESTRUCTURA (MICR칍FONO) ---
        let audioContext;
        let analyser;
        let microphone;
        let javascriptNode;

        async function initMic() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                currentStream = stream;
                audioContext = new AudioContext();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);

                analyser.smoothingTimeConstant = 0.8;
                analyser.fftSize = 1024;

                microphone.connect(analyser);
                analyser.connect(javascriptNode);
                javascriptNode.connect(audioContext.destination);

                document.getElementById('btn-mic-start').style.display = 'none';

                javascriptNode.onaudioprocess = function() {
                    var array = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(array);
                    var values = 0;
                    var length = array.length;
                    for (var i = 0; i < length; i++) { values += array[i]; }
                    var average = values / length;

                    // Visualizaci칩n
                    let percentage = Math.min(average * 2, 100); 
                    document.getElementById('mic-bar').style.width = percentage + "%";
                    document.getElementById('mic-status').innerText = "Presi칩n: " + Math.round(percentage) + "%";

                    // WIN CONDITION
                    if (percentage > 80) {
                        alert("춰TUBO DESPEJADO! Flujo de agua restablecido.");
                        stopMedia();
                        goHome();
                    }
                }
            } catch (err) {
                alert("Error de micr칩fono: " + err + ". Aseg칰rate de usar HTTPS.");
            }
        }

        // --- M칍DULO PLANTAS (C츼MARA) ---
        async function initCamera() {
            try {
                const video = document.getElementById('camera-feed');
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                currentStream = stream;
                video.srcObject = stream;
                video.style.display = 'block';
                document.getElementById('btn-cam').style.display = 'none';
                document.getElementById('btn-capture').style.display = 'block';
            } catch (err) {
                alert("Error de c치mara: " + err);
            }
        }

        function capturePhoto() {
            const video = document.getElementById('camera-feed');
            const canvas = document.getElementById('camera-canvas');
            const preview = document.getElementById('photo-preview');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            preview.src = canvas.toDataURL('image/png');
            preview.style.display = 'block';
            video.style.display = 'none';
            
            stopMedia();
            document.getElementById('btn-capture').style.display = 'none';
            document.getElementById('btn-submit-plant').style.display = 'block';
        }

        function validatePlant() {
            // Simulamos un an치lisis de IA
            const btn = document.getElementById('btn-submit-plant');
            btn.innerText = "Analizando...";
            setTimeout(() => {
                alert("AN츼LISIS COMPLETADO: Diagrama v치lido. Deficiencia de Hierro confirmada. Nutrientes a침adidos.");
                goHome();
            }, 1500);
        }

        // --- M칍DULO AGUA ---
        function checkWater() {
            const val = document.getElementById('ph-selector').value;
            if (val === "7") {
                alert("춰CORRECTO! El rango 6.8 - 7.2 permite que peces y bacterias coexistan.");
                goHome();
            } else {
                alert("PELIGRO: Ese pH matar칤a a las bacterias nitrificantes o a los peces.");
            }
        }

        // --- M칍DULO PECES (AUDIO) ---
        function playSound() {
            // Oscilador simple para simular sonido de burbujas
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gainNode = ctx.createGain();
            
            osc.type = 'sine';
            osc.frequency.setValueAtTime(150, ctx.currentTime); // Sonido grave (bomba)
            osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 2);
            
            gainNode.gain.setValueAtTime(0.5, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 2);

            osc.connect(gainNode);
            gainNode.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + 2);
        }

        function finishFish() {
            alert("Correcto. El sonido es normal, pero los peces boquean en la superficie. Falta Ox칤geno disuelto.");
            goHome();
        }

    </script>
</body>
</html>
