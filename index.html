<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Acuapon√≠a Builder V17: Ultra Compacto</title>
    <style>
        /* ESTILOS GENERALES */
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #eceff1; color: #333; margin: 0; padding: 0; user-select: none; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        /* HEADER */
        header { background: #263238; color: white; padding: 0 10px; display: flex; justify-content: space-between; align-items: center; height: 40px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 20; flex-shrink: 0; }
        h1 { font-size: 0.85rem; margin: 0; display: flex; align-items: center; gap: 5px; }
        
        .stats-bar { display: flex; gap: 8px; align-items: center; font-size: 0.65rem; overflow-x: auto; white-space: nowrap; padding-left: 5px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .stats-bar::-webkit-scrollbar { display: none; }
        .stat-item { background: #37474f; padding: 2px 5px; border-radius: 3px; display: flex; align-items: center; gap: 3px; }
        .stat-val { font-weight: bold; color: #4fc3f7; }
        
        .health-indicator { width: 6px; height: 6px; border-radius: 50%; background: #66bb6a; display: inline-block; }
        .health-low { background: #ef5350; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* LAYOUT PRINCIPAL */
        .main-layout { display: grid; grid-template-columns: 200px 1fr 300px; flex: 1; overflow: hidden; position: relative; transition: all 0.3s; }
        
        /* 1. INVENTARIO */
        .inventory { background: #fff; border-right: 1px solid #ddd; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; z-index: 10; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        .inv-section { font-weight: bold; color: #0277bd; margin-top: 5px; border-bottom: 1px solid #e1f5fe; padding-bottom: 1px; font-size: 0.7rem; text-transform: uppercase; }
        
        .draggable-item { 
            background: #f5f5f5; border: 1px solid #ccc; border-radius: 4px; padding: 5px; 
            cursor: grab; display: flex; align-items: center; gap: 6px; transition: all 0.2s; font-size: 0.75rem;
            touch-action: none;
        }
        .draggable-item:hover { transform: translateX(2px); background: #e3f2fd; border-color: #2196f3; }
        .draggable-item.locked { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); pointer-events: none; }
        .item-icon { font-size: 1rem; min-width: 18px; text-align: center; }

        /* GHOST DRAG */
        .drag-ghost {
            position: fixed; pointer-events: none; z-index: 9999; opacity: 0.9;
            background: white; padding: 5px 10px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border: 2px solid #2196f3; transform: translate(-50%, -50%); font-size: 0.8rem; font-weight: bold;
            display: flex; align-items: center; gap: 5px; white-space: nowrap;
        }

        /* 2. ZONA DE CONSTRUCCI√ìN */
        .workspace { 
            position: relative; background-image: radial-gradient(#cfd8dc 1px, transparent 1px); 
            background-size: 20px 20px; background-color: #eceff1; overflow: hidden; 
            display: flex; justify-content: center; align-items: center; 
        }
        
        /* Tablero escalable fijo 800x600 */
        .game-board { 
            position: relative; width: 800px; height: 600px; 
            transform-origin: center center; 
            box-shadow: 0 0 50px rgba(0,0,0,0.05); border-radius: 20px;
            background: rgba(255,255,255,0.3);
        }

        /* Instrucciones Flotantes */
        .instruction-panel {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95); padding: 4px 12px; border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-weight: bold; color: #006064;
            border: 1px solid #00bcd4; z-index: 50; text-align: center; width: auto; min-width: 200px; font-size: 0.75rem;
            pointer-events: none; white-space: nowrap;
        }

        /* 3. PANEL EDUCATIVO */
        .edu-sidebar { background: white; border-left: 1px solid #ccc; overflow-y: auto; padding: 0; display: flex; flex-direction: column; }
        .ai-control-panel { background: #f3e5f5; padding: 8px; border-bottom: 1px solid #e1bee7; position: sticky; top: 0; z-index: 20; display: flex; flex-direction: column; gap: 5px; }
        .ai-buttons { display: flex; gap: 5px; }
        .btn-ai { flex: 1; background: white; border: 1px solid #6200ea; color: #6200ea; padding: 5px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.7rem; }
        .manual-content { padding: 10px; font-size: 0.75rem; line-height: 1.4; color: #444; }
        .manual-content h2 { font-size: 0.85rem; color: #0277bd; border-bottom: 1px solid #b3e5fc; margin-top: 10px; margin-bottom: 5px; }
        .highlight-box { background: #e0f2f1; padding: 5px; border-radius: 4px; border-left: 3px solid #009688; margin: 5px 0; font-size: 0.7rem; }

        /* SVG TUBER√çAS */
        .pipes-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .pipe-path { fill: none; stroke: #cfd8dc; stroke-width: 6; stroke-linecap: round; stroke-linejoin: round; transition: stroke 1s; }
        .pipe-water { fill: none; stroke: #4fc3f7; stroke-width: 3; stroke-linecap: round; stroke-dasharray: 8; animation: flow 1s linear infinite; opacity: 0; transition: opacity 1s; }
        @keyframes flow { to { stroke-dashoffset: -16; } }

        /* SLOTS (Zonas de ca√≠da) */
        .drop-zone { 
            position: absolute; border: 2px dashed #b0bec5; background: rgba(255,255,255,0.4); 
            border-radius: 6px; display: flex; flex-direction: column; justify-content: center; align-items: center; 
            color: #78909c; font-size: 0.65rem; text-align: center; transition: all 0.3s; z-index: 2;
        }
        .drop-zone.hovered { background: rgba(129, 199, 132, 0.6); border-color: #4caf50; transform: scale(1.05); }
        .drop-zone.filled { border: none; background: transparent; }
        .label-tag { position: absolute; bottom: -15px; width: 100%; text-align: center; background: #333; color: white; padding: 1px 0; font-size: 8px; border-radius: 2px; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .drop-zone.filled:hover .label-tag { opacity: 1; }

        /* POSICIONES M√ÅS CENTRADAS */
        #slot-tank { bottom: 80px; left: 50%; transform: translateX(-50%); width: 220px; height: 100px; }
        #slot-bed { top: 80px; right: 150px; width: 160px; height: 80px; }
        #slot-mech { top: 120px; left: 120px; width: 50px; height: 80px; }
        #slot-bio { top: 120px; left: 200px; width: 50px; height: 80px; }
        #slot-pump { bottom: 30px; left: calc(50% - 80px); width: 30px; height: 30px; z-index: 5; }
        #slot-pipes { top: 55%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 40px; }

        /* COMPONENTES VISUALES */
        .object { width: 100%; height: 100%; position: relative; display: none; cursor: help; }
        .object.visible { display: block; animation: popIn 0.4s ease-out; }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .visual-tank { background: rgba(33, 150, 243, 0.1); border: 2px solid #1976d2; border-radius: 0 0 8px 8px; border-top: none; position: relative; overflow: hidden; }
        .visual-bed { background: #795548; border: 2px solid #4e342e; border-radius: 4px; position: relative; overflow: hidden; }
        .visual-mech { background: #bdbdbd; border: 2px solid #616161; border-radius: 3px 3px 8px 8px; display: flex; align-items: center; justify-content: center; }
        .visual-mech::after { content: "üåÄ"; font-size: 16px; opacity: 0.5; }
        .visual-bio { background: #4db6ac; border: 2px solid #00796b; border-radius: 3px; display: flex; flex-wrap: wrap; align-content: center; justify-content: center; gap: 1px; padding: 1px; }
        .bio-ball { width: 6px; height: 6px; background: #004d40; border-radius: 50%; opacity: 0.3; }
        .visual-pump { background: #263238; border-radius: 50%; border: 2px solid #000; box-shadow: 0 0 3px rgba(0,0,0,0.5); }

        .water-fill { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background: rgba(33, 150, 243, 0.5); transition: height 1.5s ease-in-out; }
        .water-fill.dirty { background: rgba(141, 110, 99, 0.6); }
        
        .fish-mob { position: absolute; font-size: 16px; transition: all 1s; pointer-events: none; }
        .fish-dead { transform: rotate(180deg) !important; filter: grayscale(100%); transition: transform 0.5s; }
        .plant-mob { position: absolute; bottom: 2px; font-size: 0px; transition: font-size 1s; transform-origin: bottom center; }

        .floater { position: fixed; font-weight: bold; pointer-events: none; animation: floatUp 1.5s ease-out forwards; z-index: 200; text-shadow: 0 0 3px white; font-size: 1rem; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-30px); } }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 85%; max-width: 350px; padding: 20px; border-radius: 10px; text-align: center; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-height: 80vh; overflow-y: auto; }

        /* MEDIA QUERIES M√ìVIL (VERTICAL) */
        @media (max-width: 900px) {
            .main-layout { grid-template-columns: 1fr; grid-template-rows: 1fr auto auto; }
            
            /* √Årea de Juego: Ocupa casi toda la pantalla */
            .workspace { order: 1; height: 60vh; background-size: 15px 15px; }
            
            /* Inventario: Barra inferior compacta */
            .inventory { 
                order: 2; width: 100%; height: 80px; flex-direction: row; border-right: none; border-top: 2px solid #ccc;
                overflow-x: auto; overflow-y: hidden; padding: 5px; gap: 5px; align-items: center;
                background: #fafafa;
            }
            .inv-section { display: none; } 
            .draggable-item { 
                min-width: 60px; width: 60px; height: 60px;
                flex-direction: column; justify-content: center; text-align: center; 
                font-size: 0.6rem; padding: 2px; border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            .item-icon { font-size: 1.2rem; margin-bottom: 2px; }
            
            /* Panel Educativo: Oculto o muy peque√±o abajo */
            .edu-sidebar { order: 3; height: auto; max-height: 20vh; border-left: none; border-top: 1px solid #ccc; }
            
            /* Ajuste de escalado para centrar el tablero */
            .game-board { margin: 0; }
        }
    </style>
</head>
<body>

<header>
    <h1>üå± Acuapon√≠a <span style="color:#81d4fa;">V17</span></h1>
    <div class="stats-bar">
        <div class="stat-item"><div class="health-indicator" id="ind-health"></div> ‚ù§Ô∏è <span id="stat-health">100%</span></div>
        <div class="stat-item">ü¶† <span id="stat-bac">0%</span></div>
        <div class="stat-item">üß™ <span id="stat-amm">0</span></div>
        <div class="stat-item">üíß <span id="stat-ph">7.0</span></div>
        <div class="stat-item">ü•¨ <span id="stat-grow">0%</span></div>
    </div>
</header>

<div class="main-layout">
    <div class="inventory" id="inventory-panel">
        <div class="inv-section">Estructura</div>
        <div class="draggable-item" draggable="true" data-type="tank" id="item-tank"><span class="item-icon">üü¶</span> Tanque</div>
        <div class="draggable-item" draggable="true" data-type="pump" id="item-pump"><span class="item-icon">‚öôÔ∏è</span> Bomba</div>
        <div class="draggable-item" draggable="true" data-type="mech" id="item-mech"><span class="item-icon">üóëÔ∏è</span> Filtro</div>
        <div class="draggable-item" draggable="true" data-type="bio" id="item-bio"><span class="item-icon">ü¶†</span> Biofiltro</div>
        <div class="draggable-item" draggable="true" data-type="bed" id="item-bed"><span class="item-icon">üü´</span> Cama</div>
        <div class="draggable-item" draggable="true" data-type="pipes" id="item-pipes"><span class="item-icon">üîß</span> Tubos</div>
        <div class="draggable-item" draggable="true" data-type="water" id="item-water"><span class="item-icon">üíß</span> Agua</div>

        <div class="inv-section">Biolog√≠a</div>
        <div class="draggable-item locked" draggable="true" data-type="ammonia" id="item-ammonia"><span class="item-icon">üß™</span> NH3</div>
        <div class="draggable-item locked" draggable="true" data-type="fish" id="item-fish"><span class="item-icon">üêü</span> Peces</div>
        
        <div class="inv-section">Cultivos</div>
        <div class="draggable-item locked" draggable="true" data-type="lettuce" id="item-lettuce"><span class="item-icon">ü•¨</span> Lechuga</div>
        <div class="draggable-item locked" draggable="true" data-type="tomato" id="item-tomato"><span class="item-icon">üçÖ</span> Tomate</div>
        <div class="draggable-item locked" draggable="true" data-type="berry" id="item-berry"><span class="item-icon">üçì</span> Fresa</div>
        
        <div class="inv-section">Cuidados</div>
        <div class="draggable-item locked" draggable="true" data-type="food" id="item-food"><span class="item-icon">ü¶ê</span> Comida</div>
        <div class="draggable-item locked" draggable="true" data-type="base" id="item-base"><span class="item-icon">üíä</span> pH+</div>
        <div class="draggable-item locked" draggable="true" data-type="acid" id="item-acid"><span class="item-icon">üçã</span> pH-</div>
    </div>

    <div class="workspace" id="workspace">
        <div class="instruction-panel" id="instruction">Arrastra el TANQUE al centro.</div>
        
        <div class="game-board" id="game-board">
            <svg class="pipes-layer">
                <path id="path-1" class="pipe-path" d="M0 0" /><path id="flow-1" class="pipe-water" d="M0 0" />
                <path id="path-2" class="pipe-path" d="M0 0" /><path id="flow-2" class="pipe-water" d="M0 0" />
                <path id="path-3" class="pipe-path" d="M0 0" /><path id="flow-3" class="pipe-water" d="M0 0" />
                <path id="path-4" class="pipe-path" d="M0 0" /><path id="flow-4" class="pipe-water" d="M0 0" />
            </svg>

            <div id="slot-tank" class="drop-zone" data-accept="tank,water,ammonia,fish,food,base,acid">üìç<div class="object visual-tank" id="obj-tank"><div class="water-fill" id="water-tank"></div><div id="fish-container" style="position:absolute; inset:0;"></div><div class="label-tag">Tanque</div></div></div>
            <div id="slot-pump" class="drop-zone" data-accept="pump">‚öôÔ∏è<div class="object visual-pump" id="obj-pump"><div class="label-tag">Bomba</div></div></div>
            <div id="slot-mech" class="drop-zone" data-accept="mech">üóëÔ∏è<div class="object visual-mech" id="obj-mech"><div class="label-tag">Filtro</div></div></div>
            <div id="slot-bio" class="drop-zone" data-accept="bio">ü¶†<div class="object visual-bio" id="obj-bio"><div class="bio-ball"></div><div class="bio-ball"></div><div class="bio-ball"></div><div class="bio-ball"></div><div class="label-tag">Bio</div></div></div>
            <div id="slot-bed" class="drop-zone" data-accept="bed,lettuce,tomato,berry">üü´<div class="object visual-bed" id="obj-bed"><div class="water-fill" id="water-bed"></div><div id="plants-container" style="position:absolute; bottom:0; width:100%; text-align:center;"></div><div class="label-tag">Cama</div></div></div>
            <div id="slot-pipes" class="drop-zone" data-accept="pipes">üîó<div class="object" id="obj-pipes" style="display:none;"></div></div>
        </div>
    </div>

    <div class="edu-sidebar">
        <div class="ai-control-panel">
            <div class="ai-buttons">
                <button class="btn-ai" onclick="askAI('diagnosis')">üîç Diagn√≥stico</button>
                <button class="btn-ai" onclick="askAI('tips')">üí° Tip</button>
            </div>
        </div>
        <div class="manual-content">
            <h2>FUNDAMENTOS</h2>
            <p>Sistema simbi√≥tico: Peces ‚ûî Bacterias ‚ûî Plantas.</p>
            <h2>PAR√ÅMETROS</h2>
            <div class="highlight-box">üå°Ô∏è 20-28¬∞C | üß™ pH 6.8-7.2 | ‚ò†Ô∏è NH3 < 1</div>
            <p>Vigila el agua turbia y el pH bajo.</p>
        </div>
    </div>
</div>

<div id="modal-ai" class="modal-overlay">
    <div class="modal-box">
        <h2 style="color:#6200ea;" id="ai-title">IA</h2>
        <div id="ai-content">...</div>
        <button class="btn-ai" style="margin-top:15px; width:auto;" onclick="document.getElementById('modal-ai').style.display='none'">Cerrar</button>
    </div>
</div>

<div id="modal-victory" class="modal-overlay">
    <div class="modal-box" style="border: 3px solid gold;">
        <h1 style="color:gold; font-size: 2rem; margin:0;">üèÜ</h1>
        <h2 style="color:#006064;">¬°COSECHA!</h2>
        <p>Ciclo completado con √©xito.</p>
        <div style="margin: 10px; padding: 10px; border: 2px dashed #00bcd4; background: #e0f7fa; border-radius: 10px;">
            <h3 style="margin-top:0;">CERTIFICADO</h3>
            <p style="font-size:0.8rem;">Maestro Acuaponista</p>
        </div>
        <button class="btn-ai" style="margin:0 auto;" onclick="location.reload()">Reiniciar</button>
    </div>
</div>

<div id="modal-gameover" class="modal-overlay">
    <div class="modal-box" style="border: 3px solid #ef5350;">
        <h1 style="font-size: 2rem; margin:0;">‚ò†Ô∏è</h1>
        <h2 style="color:#c62828;">Game Over</h2>
        <p id="death-reason">Peces muertos.</p>
        <button class="btn-ai" style="margin: 10px auto; background:#ef5350; color:white;" onclick="location.reload()">Reintentar</button>
    </div>
</div>

<script>
    function resizeBoard() {
        const board = document.getElementById('game-board');
        const container = document.getElementById('workspace');
        
        // C√°lculo inteligente de escala
        const targetWidth = 820;
        const targetHeight = 620;
        const availableWidth = container.clientWidth;
        const availableHeight = container.clientHeight;
        
        // Escalar para ajustar, dejando un peque√±o margen (0.95)
        const scale = Math.min(availableWidth / targetWidth, availableHeight / targetHeight) * 0.95;
        
        board.style.transform = `scale(${scale})`;
    }
    window.addEventListener('resize', () => { resizeBoard(); updatePipes(); });
    setTimeout(resizeBoard, 100);

    function updatePipes() {
        // Coordenadas ajustadas a las nuevas posiciones m√°s centradas
        const pPump = {x: 310, y: 565}; 
        const pMech = {x: 135, y: 165}; // slot-mech top 120 + height 80/2 = 160
        const pBio = {x: 215, y: 165};  // slot-bio top 120 + height 80/2 = 160
        const pBed = {x: 560, y: 125};  // slot-bed top 80 + height 80/2 = 120. right 150 -> 800-150-160 = 490 start. Center 490+80 = 570.
        const pTank = {x: 400, y: 505};

        setPath('path-1', `M ${pPump.x} ${pPump.y} V ${pMech.y} H ${pMech.x}`); setPath('flow-1', `M ${pPump.x} ${pPump.y} V ${pMech.y} H ${pMech.x}`);
        setPath('path-2', `M ${pMech.x} ${pMech.y} H ${pBio.x}`); setPath('flow-2', `M ${pMech.x} ${pMech.y} H ${pBio.x}`);
        setPath('path-3', `M ${pBio.x} ${pBio.y} H ${pBed.x}`); setPath('flow-3', `M ${pBio.x} ${pBio.y} H ${pBed.x}`);
        const bedOutX = pBed.x + 70;
        setPath('path-4', `M ${bedOutX} ${pBed.y} V ${pTank.y - 55} H ${pTank.x + 80} V ${pTank.y}`); setPath('flow-4', `M ${bedOutX} ${pBed.y} V ${pTank.y - 55} H ${pTank.x + 80} V ${pTank.y}`);
    }
    function setPath(id, d) { document.getElementById(id).setAttribute('d', d); }
    setTimeout(updatePipes, 500);

    const STATE = { built: {}, chem: { bacteria:0, ammonia:0, ph:7 }, life: { fish:0, health:100, plants:0, plantType:null }, loop: null, gameOver:false };
    const PLANT_DATA = { lettuce: { name: "Lechuga", growthRate: 0.3, icon: "ü•¨" }, tomato: { name: "Tomate", growthRate: 0.15, icon: "üçÖ" }, berry: { name: "Fresa", growthRate: 0.1, icon: "üçì" } };

    const draggables = document.querySelectorAll('.draggable-item');
    const dropZones = document.querySelectorAll('.drop-zone');

    draggables.forEach(d => d.addEventListener('dragstart', e => { if(!d.classList.contains('locked')) e.dataTransfer.setData('type', d.dataset.type); }));
    dropZones.forEach(z => {
        z.addEventListener('dragover', e => { e.preventDefault(); z.classList.add('hovered'); });
        z.addEventListener('dragleave', e => { z.classList.remove('hovered'); });
        z.addEventListener('drop', e => { e.preventDefault(); z.classList.remove('hovered'); handleAction(z, e.dataTransfer.getData('type'), e.clientX, e.clientY); });
    });

    let activeTouchItem = null;
    let ghostEl = null;
    draggables.forEach(d => {
        d.addEventListener('touchstart', e => {
            if(d.classList.contains('locked')) return;
            e.preventDefault(); activeTouchItem = d;
            ghostEl = d.cloneNode(true); ghostEl.classList.add('drag-ghost'); document.body.appendChild(ghostEl);
            moveGhost(e.touches[0]);
        });
        d.addEventListener('touchmove', e => { if(!activeTouchItem) return; e.preventDefault(); moveGhost(e.touches[0]); });
        d.addEventListener('touchend', e => {
            if(!activeTouchItem) return;
            const touch = e.changedTouches[0];
            ghostEl.style.display = 'none';
            const elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            ghostEl.style.display = 'flex';
            const zone = elemBelow ? elemBelow.closest('.drop-zone') : null;
            if(zone) { handleAction(zone, activeTouchItem.dataset.type, touch.clientX, touch.clientY); zone.classList.remove('hovered'); }
            if(ghostEl) ghostEl.remove(); activeTouchItem = null; ghostEl = null;
        });
    });
    function moveGhost(touch) { if(ghostEl) { ghostEl.style.left = touch.clientX + 'px'; ghostEl.style.top = touch.clientY + 'px'; } }

    function handleAction(zone, type, x, y) {
        if(STATE.gameOver) return;
        const accept = zone.dataset.accept.split(',');
        if(!accept.includes(type)) return;

        // Funci√≥n para borrar √≠tem del inventario
        const removeItem = () => {
            const el = document.getElementById(`item-${type}`);
            if(el) el.style.display = 'none';
        };

        if(['tank','pump','mech','bio','bed'].includes(type)) {
            if(!STATE.built[type]) {
                STATE.built[type] = 1;
                document.getElementById(`slot-${type}`).classList.add('filled');
                document.getElementById(`obj-${type}`).classList.add('visible');
                removeItem(); // Desaparecer del inventario
                if(Object.keys(STATE.built).length >= 5) updateInstruction("Arrastra las TUBER√çAS para conectar.");
                setTimeout(updatePipes, 100);
            }
        }
        else if(type === 'pipes') {
            if(Object.keys(STATE.built).length >= 5) {
                STATE.built.pipes = 1;
                document.getElementById('slot-pipes').classList.add('filled');
                document.getElementById('slot-pipes').innerHTML = "";
                document.querySelectorAll('.pipe-path').forEach(p => p.style.stroke = '#546e7a');
                removeItem(); // Desaparecer
                updateInstruction("Llenar AGUA");
            } else showToast("Faltan piezas", x, y, "red");
        }
        else if(type === 'water') {
            if(STATE.built.pipes) {
                STATE.built.water = 1;
                document.getElementById('water-tank').style.height = '80%';
                document.getElementById('water-bed').style.height = '60%';
                document.querySelectorAll('.pipe-water').forEach(p => p.style.opacity = 1);
                removeItem(); // Desaparecer
                document.getElementById('item-ammonia').classList.remove('locked');
                updateInstruction("A√±ade AMON√çACO");
                if(!STATE.loop) STATE.loop = setInterval(simLoop, 1000);
            } else showToast("Faltan tubos", x, y, "red");
        }
        else if(type === 'ammonia') { STATE.chem.ammonia += 5; showToast("+5 NH3", x, y, "brown"); removeItem(); }
        else if(type === 'fish') {
            if(STATE.chem.bacteria > 80) {
                STATE.life.fish = 10; removeItem();
                unlock('lettuce'); unlock('tomato'); unlock('berry');
                addFishVisuals();
                updateInstruction("Siembra SEMILLAS");
            } else showToast("Agua t√≥xica", x, y, "red");
        }
        else if(['lettuce','tomato','berry'].includes(type)) {
            STATE.life.plants = 1; STATE.life.plantType = type;
            document.getElementById('item-lettuce').parentElement.style.display='none'; // Ocultar secci√≥n completa
            unlock('food'); unlock('base'); unlock('acid');
            addPlantVisuals(type);
            updateInstruction(`Cultivando ${PLANT_DATA[type].name}. Cuida pH y Peces.`);
        }
        else if(type === 'food') { STATE.chem.ammonia += 2; showToast("√ëam", x, y, "orange"); }
        else if(type === 'base') { STATE.chem.ph += 0.5; showToast("pH +", x, y, "purple"); }
        else if(type === 'acid') { STATE.chem.ph -= 0.5; showToast("pH -", x, y, "orange"); }
    }

    function simLoop() {
        if(STATE.gameOver) return;
        if(STATE.chem.ammonia > 0 && STATE.chem.bacteria < 100) {
            STATE.chem.bacteria += 2.0; STATE.chem.ammonia -= 0.1;
            if(STATE.chem.bacteria > 80) unlock('fish');
        }
        if(STATE.life.fish > 0) {
            STATE.chem.ammonia += 0.1; 
            if(STATE.chem.ammonia > 5 || STATE.chem.ph < 6.0 || STATE.chem.ph > 8.0) STATE.life.health -= 2;
            else if(STATE.life.health < 100) STATE.life.health += 0.5;
            if(STATE.life.health <= 0) { triggerGameOver(STATE.chem.ammonia > 5 ? "Intoxicaci√≥n" : "pH Letal"); return; }
            let clean = STATE.chem.ammonia * (STATE.chem.bacteria/100) * 0.5;
            STATE.chem.ammonia -= clean;
            if(clean > 0) STATE.chem.ph -= 0.002;
        }
        if(STATE.life.plants > 0 && STATE.life.plantType) {
            if(STATE.chem.ph > 6 && STATE.chem.ph < 7.5 && STATE.life.health > 50) {
                STATE.life.plants += PLANT_DATA[STATE.life.plantType].growthRate;
            }
            if(STATE.life.plants >= 100) {
                STATE.life.plants = 100; document.getElementById('modal-victory').style.display = 'flex'; STATE.gameOver = true;
            }
        }
        STATE.chem.ammonia = Math.max(0, STATE.chem.ammonia);
        updateUI();
    }

    function updateUI() {
        document.getElementById('stat-bac').innerText = Math.floor(STATE.chem.bacteria) + "%";
        document.getElementById('stat-amm').innerText = STATE.chem.ammonia.toFixed(1);
        document.getElementById('stat-ph').innerText = STATE.chem.ph.toFixed(1);
        document.getElementById('stat-grow').innerText = Math.floor(STATE.life.plants) + "%";
        document.getElementById('stat-health').innerText = Math.floor(STATE.life.health) + "%";
        let ind = document.getElementById('ind-health');
        if(STATE.life.health < 50) ind.classList.add('health-low'); else ind.classList.remove('health-low');
        if(STATE.chem.ammonia > 10) document.getElementById('water-tank').classList.add('dirty'); else document.getElementById('water-tank').classList.remove('dirty');
        if(STATE.life.plants > 0) {
            let size = 10 + STATE.life.plants/2;
            let icon = PLANT_DATA[STATE.life.plantType].icon;
            document.querySelectorAll('.plant-mob').forEach(p => { p.style.fontSize = size+"px"; p.innerText = icon; });
        }
    }

    function addFishVisuals() {
        const c = document.getElementById('fish-container');
        for(let i=0; i<5; i++) {
            let f = document.createElement('div'); f.className = 'fish-mob'; f.innerText='üêü';
            f.style.left=Math.random()*80+'%'; f.style.top=Math.random()*80+'%'; c.appendChild(f);
        }
        setInterval(() => {
            if(STATE.life.health > 0) document.querySelectorAll('.fish-mob').forEach(f => {
                f.style.left=Math.random()*80+'%'; f.style.transform=Math.random()>0.5?'scaleX(1)':'scaleX(-1)';
            });
        }, 2000);
    }

    function addPlantVisuals(type) {
        const c = document.getElementById('plants-container');
        let icon = PLANT_DATA[type].icon;
        for(let i=0; i<4; i++) {
            let p = document.createElement('div'); p.className='plant-mob'; p.innerText=icon;
            p.style.left=(20+i*20)+'%'; c.appendChild(p);
        }
    }

    function triggerGameOver(reason) {
        STATE.gameOver = true;
        document.getElementById('death-reason').innerText = "Causa: " + reason;
        document.getElementById('modal-gameover').style.display = 'flex';
        document.querySelectorAll('.fish-mob').forEach(f => f.classList.add('fish-dead'));
    }

    function updateInstruction(t) { document.getElementById('instruction').innerText = t; }
    function unlock(id) { document.getElementById('item-'+id).classList.remove('locked'); }
    function showToast(m, x, y, c) {
        let t = document.createElement('div'); t.innerText = m; t.className = 'floater';
        t.style.left = x + 'px'; t.style.top = y + 'px'; t.style.color = c;
        document.body.appendChild(t); setTimeout(() => t.remove(), 1500);
    }

    function askAI(mode) {
        document.getElementById('modal-ai').style.display = 'flex';
        document.getElementById('ai-title').innerText = mode==='diagnosis'?'Diagn√≥stico':'Tip';
        let msg = "";
        if(mode === 'diagnosis') {
            msg = `<b>Salud: ${Math.floor(STATE.life.health)}%</b><br>pH: ${STATE.chem.ph.toFixed(1)} | NH3: ${STATE.chem.ammonia.toFixed(1)}<br><br>`;
            if(STATE.life.health < 50) msg += "‚ö†Ô∏è <b>CR√çTICO:</b> Peces muriendo. Revisa pH y Amon√≠aco.";
            else if(STATE.chem.ammonia > 4) msg += "‚ö†Ô∏è <b>ALERTA:</b> Amon√≠aco subiendo. Deja de alimentar.";
            else msg += "‚úÖ Sistema Estable.";
        } else {
            msg = "üí° <b>Tip:</b> Las bacterias necesitan oscuridad. Evita que la luz solar d√© directo al biofiltro.";
        }
        document.getElementById('ai-content').innerHTML = msg;
    }
</script>
</body>
</html>
