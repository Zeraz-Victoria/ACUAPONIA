<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acuapon√≠a Builder V13: Final</title>
    <style>
        /* ESTILOS GENERALES */
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #eceff1; color: #333; margin: 0; padding: 0; user-select: none; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        /* HEADER */
        header { background: #263238; color: white; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; height: 50px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 20; flex-shrink: 0; }
        h1 { font-size: 1.1rem; margin: 0; display: flex; align-items: center; gap: 10px; }
        
        .stats-bar { display: flex; gap: 15px; align-items: center; font-size: 0.85rem; }
        .stat-item { background: #37474f; padding: 4px 8px; border-radius: 4px; display: flex; align-items: center; gap: 5px; }
        .stat-val { font-weight: bold; color: #4fc3f7; }

        /* LAYOUT PRINCIPAL (3 COLUMNAS) */
        .main-layout { display: grid; grid-template-columns: 220px 1fr 350px; flex: 1; overflow: hidden; position: relative; }
        
        /* 1. INVENTARIO (IZQUIERDA) */
        .inventory { background: #fff; border-right: 1px solid #ddd; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; z-index: 10; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        .inv-section { font-weight: bold; color: #0277bd; margin-top: 10px; border-bottom: 2px solid #e1f5fe; padding-bottom: 2px; font-size: 0.9rem; }
        
        .draggable-item { 
            background: #f5f5f5; border: 1px solid #ccc; border-radius: 6px; padding: 8px; 
            cursor: grab; display: flex; align-items: center; gap: 10px; transition: all 0.2s; font-size: 0.85rem;
        }
        .draggable-item:hover { transform: translateX(5px); background: #e3f2fd; border-color: #2196f3; }
        .draggable-item:active { cursor: grabbing; }
        .draggable-item.locked { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); pointer-events: none; }
        .item-icon { font-size: 1.2rem; min-width: 25px; text-align: center; }

        /* 2. ZONA DE CONSTRUCCI√ìN (CENTRO) */
        .workspace { position: relative; background-image: radial-gradient(#cfd8dc 1px, transparent 1px); background-size: 20px 20px; background-color: #eceff1; overflow: hidden; }
        
        /* Instrucciones Flotantes (Dentro del juego) */
        .instruction-panel {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95); padding: 8px 20px; border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-weight: bold; color: #006064;
            border: 2px solid #00bcd4; z-index: 50; text-align: center; width: 70%; font-size: 0.9rem;
            pointer-events: none;
        }

        /* 3. PANEL EDUCATIVO (DERECHA) */
        .edu-sidebar { 
            background: white; border-left: 1px solid #ccc; overflow-y: auto; padding: 0; 
            display: flex; flex-direction: column; box-shadow: -2px 0 5px rgba(0,0,0,0.05);
        }
        
        /* Panel de Control IA (Dentro de la barra derecha) */
        .ai-control-panel {
            background: #f3e5f5; padding: 15px; border-bottom: 1px solid #e1bee7;
            position: sticky; top: 0; z-index: 20;
        }
        .ai-title { color: #6200ea; font-weight: bold; margin-bottom: 10px; display: block; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        .ai-buttons { display: flex; gap: 10px; }
        .btn-ai { 
            flex: 1; background: white; border: 1px solid #6200ea; color: #6200ea; 
            padding: 8px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.8rem; 
            transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .btn-ai:hover { background: #6200ea; color: white; }

        /* Contenido del Manual */
        .manual-content { padding: 20px; font-size: 0.9rem; line-height: 1.5; color: #444; }
        .manual-content h2 { font-size: 1.1rem; color: #0277bd; border-bottom: 2px solid #b3e5fc; padding-bottom: 5px; margin-top: 25px; margin-bottom: 10px; }
        .manual-content h2:first-child { margin-top: 0; }
        .manual-content h3 { font-size: 0.95rem; color: #006064; margin-top: 15px; margin-bottom: 5px; font-weight: bold; }
        .manual-content ul { padding-left: 20px; margin: 5px 0; }
        .manual-content li { margin-bottom: 5px; }
        .highlight-box { background: #e0f2f1; padding: 10px; border-radius: 5px; border-left: 4px solid #009688; margin: 10px 0; }

        /* SISTEMA DE TUBER√çAS (SVG) */
        .pipes-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .pipe-path { fill: none; stroke: #cfd8dc; stroke-width: 8; stroke-linecap: round; stroke-linejoin: round; transition: stroke 1s; }
        .pipe-water { fill: none; stroke: #4fc3f7; stroke-width: 4; stroke-linecap: round; stroke-dasharray: 10; animation: flow 1s linear infinite; opacity: 0; transition: opacity 1s; }
        @keyframes flow { to { stroke-dashoffset: -20; } }

        /* ZONAS DE CA√çDA (SLOTS) */
        .drop-zone { 
            position: absolute; border: 2px dashed #90a4ae; background: rgba(255,255,255,0.5); 
            border-radius: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center; 
            color: #78909c; font-size: 0.75rem; text-align: center; transition: all 0.3s; z-index: 2;
        }
        .drop-zone.hovered { background: rgba(129, 199, 132, 0.6); border-color: #4caf50; transform: scale(1.05); }
        .drop-zone.filled { border: none; background: transparent; }
        
        /* ETIQUETAS DE COMPONENTES */
        .label-tag {
            position: absolute; bottom: -20px; width: 100%; text-align: center;
            background: #333; color: white; padding: 2px 0; font-size: 10px; border-radius: 4px;
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .drop-zone.filled:hover .label-tag { opacity: 1; }

        /* POSICIONES REDISE√ëADAS (Ajustadas al nuevo layout) */
        #slot-tank { bottom: 20px; left: 50%; transform: translateX(-50%); width: 280px; height: 140px; }
        #slot-bed { top: 60px; right: 30px; width: 220px; height: 100px; }
        #slot-mech { top: 80px; left: 30px; width: 80px; height: 110px; }
        #slot-bio { top: 80px; left: 140px; width: 80px; height: 110px; }
        #slot-pump { bottom: 30px; left: calc(50% - 110px); width: 40px; height: 40px; z-index: 5; }
        #slot-pipes { top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100px; height: 60px; }

        /* OBJETOS VISUALES */
        .object { width: 100%; height: 100%; position: relative; display: none; cursor: help; }
        .object.visible { display: block; animation: popIn 0.4s ease-out; }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Estilos componentes */
        .visual-tank { background: rgba(33, 150, 243, 0.1); border: 3px solid #1976d2; border-radius: 0 0 10px 10px; border-top: none; position: relative; overflow: hidden; }
        .visual-bed { background: #795548; border: 3px solid #4e342e; border-radius: 5px; position: relative; overflow: hidden; }
        .visual-mech { background: #bdbdbd; border: 3px solid #616161; border-radius: 5px 5px 15px 15px; display: flex; align-items: center; justify-content: center; }
        .visual-mech::after { content: "üåÄ"; font-size: 20px; opacity: 0.5; }
        .visual-bio { background: #4db6ac; border: 3px solid #00796b; border-radius: 5px; display: flex; flex-wrap: wrap; align-content: center; justify-content: center; gap: 2px; padding: 5px; }
        .bio-ball { width: 8px; height: 8px; background: #004d40; border-radius: 50%; opacity: 0.3; }
        .visual-pump { background: #263238; border-radius: 50%; border: 2px solid #000; box-shadow: 0 0 5px rgba(0,0,0,0.5); }

        /* AGUA Y VIDA */
        .water-fill { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background: rgba(33, 150, 243, 0.5); transition: height 1.5s ease-in-out; }
        .water-fill.dirty { background: rgba(141, 110, 99, 0.6); }
        .fish-mob { position: absolute; font-size: 20px; transition: all 1s; pointer-events: none; }
        .plant-mob { position: absolute; bottom: 5px; font-size: 0px; transition: font-size 1s; transform-origin: bottom center; }

        /* TOASTS */
        .floater { position: absolute; font-weight: bold; pointer-events: none; animation: floatUp 1.5s ease-out forwards; z-index: 200; text-shadow: 0 0 3px white; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-40px); } }

        /* MODAL IA */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 90%; max-width: 500px; padding: 25px; border-radius: 10px; text-align: center; position: relative; }
        
    </style>
</head>
<body>

<header>
    <h1>üå± Acuapon√≠a <span style="color:#81d4fa;">PRO</span></h1>
    <div class="stats-bar">
        <div class="stat-item" title="Bacterias Nitrificantes">ü¶† <span id="stat-bac">0%</span></div>
        <div class="stat-item" title="Nivel de Amon√≠aco">üß™ <span id="stat-amm">0</span></div>
        <div class="stat-item" title="Acidez del agua">üíß pH <span id="stat-ph">7.0</span></div>
        <div class="stat-item" title="Progreso de Cosecha">ü•¨ <span id="stat-grow">0%</span></div>
    </div>
</header>

<div class="main-layout">
    
    <!-- 1. INVENTARIO -->
    <div class="inventory">
        <div class="inv-section">1. Estructura</div>
        <div class="draggable-item" draggable="true" data-type="tank" id="item-tank"><span class="item-icon">üü¶</span> Tanque Peces</div>
        <div class="draggable-item" draggable="true" data-type="pump" id="item-pump"><span class="item-icon">‚öôÔ∏è</span> Bomba Agua</div>
        <div class="draggable-item" draggable="true" data-type="mech" id="item-mech"><span class="item-icon">üóëÔ∏è</span> Filtro Mec√°nico</div>
        <div class="draggable-item" draggable="true" data-type="bio" id="item-bio"><span class="item-icon">ü¶†</span> Biofiltro</div>
        <div class="draggable-item" draggable="true" data-type="bed" id="item-bed"><span class="item-icon">üü´</span> Cama Cultivo</div>
        <div class="draggable-item" draggable="true" data-type="pipes" id="item-pipes"><span class="item-icon">üîß</span> Tuber√≠as</div>
        <div class="draggable-item" draggable="true" data-type="water" id="item-water"><span class="item-icon">üíß</span> Llenar Agua</div>

        <div class="inv-section">2. Biolog√≠a</div>
        <div class="draggable-item locked" draggable="true" data-type="ammonia" id="item-ammonia"><span class="item-icon">üß™</span> Amon√≠aco</div>
        <div class="draggable-item locked" draggable="true" data-type="fish" id="item-fish"><span class="item-icon">üêü</span> Peces</div>
        <div class="draggable-item locked" draggable="true" data-type="plants" id="item-plants"><span class="item-icon">üå±</span> Semillas</div>
        
        <div class="inv-section">3. Mantenimiento</div>
        <div class="draggable-item locked" draggable="true" data-type="food" id="item-food"><span class="item-icon">ü¶ê</span> Comida</div>
        <div class="draggable-item locked" draggable="true" data-type="base" id="item-base"><span class="item-icon">üíä</span> Ajustar pH</div>
    </div>

    <!-- 2. √ÅREA DE TRABAJO -->
    <div class="workspace" id="workspace">
        
        <!-- Instrucciones -->
        <div class="instruction-panel" id="instruction">Arrastra el TANQUE DE PECES a la zona central inferior.</div>

        <!-- Capa SVG para Tuber√≠as -->
        <svg class="pipes-layer">
            <path id="path-1" class="pipe-path" d="M 0 0" />
            <path id="flow-1" class="pipe-water" d="M 0 0" />
            <path id="path-2" class="pipe-path" d="M 0 0" />
            <path id="flow-2" class="pipe-water" d="M 0 0" />
            <path id="path-3" class="pipe-path" d="M 0 0" />
            <path id="flow-3" class="pipe-water" d="M 0 0" />
            <path id="path-4" class="pipe-path" d="M 0 0" />
            <path id="flow-4" class="pipe-water" d="M 0 0" />
        </svg>

        <!-- SLOTS -->
        <div id="slot-tank" class="drop-zone" data-accept="tank,water,ammonia,fish,food,base">üìç Tanque<div class="object visual-tank" id="obj-tank"><div class="water-fill" id="water-tank"></div><div id="fish-container" style="position:absolute; inset:0;"></div><div class="label-tag">Tanque</div></div></div>
        
        <div id="slot-pump" class="drop-zone" data-accept="pump">‚öôÔ∏è<div class="object visual-pump" id="obj-pump"><div class="label-tag">Bomba</div></div></div>
        
        <div id="slot-mech" class="drop-zone" data-accept="mech">üóëÔ∏è F. Mec√°nico<div class="object visual-mech" id="obj-mech"><div class="label-tag">Decantador</div></div></div>
        
        <div id="slot-bio" class="drop-zone" data-accept="bio">ü¶† Biofiltro<div class="object visual-bio" id="obj-bio"><div class="bio-ball"></div><div class="bio-ball"></div><div class="bio-ball"></div><div class="bio-ball"></div><div class="bio-ball"></div><div class="label-tag">Biofiltro</div></div></div>
        
        <div id="slot-bed" class="drop-zone" data-accept="bed,plants">üü´ Cama Cultivo<div class="object visual-bed" id="obj-bed"><div class="water-fill" id="water-bed"></div><div id="plants-container" style="position:absolute; bottom:0; width:100%; text-align:center;"></div><div class="label-tag">Cama de Cultivo</div></div></div>
        
        <div id="slot-pipes" class="drop-zone" data-accept="pipes">üîó Conectar<div class="object" id="obj-pipes" style="display:none;"></div></div>

    </div>

    <!-- 3. PANEL EDUCATIVO (DERECHA) -->
    <div class="edu-sidebar">
        
        <!-- Controles IA (Fijos Arriba) -->
        <div class="ai-control-panel">
            <span class="ai-title">Asistente Inteligente</span>
            <div class="ai-buttons">
                <button class="btn-ai" onclick="askAI('diagnosis')">üîç Diagn√≥stico</button>
                <button class="btn-ai" onclick="askAI('tips')">üí° Tip Experto</button>
            </div>
        </div>

        <!-- Contenido del Manual -->
        <div class="manual-content">
            <h2>CONCEPTOS B√ÅSICOS</h2>
            <h3>1. ¬øQu√© es un sistema acuap√≥nico?</h3>
            <p>Es un m√©todo que combina <b>acuicultura</b> (peces) con <b>hidropon√≠a</b> (plantas sin tierra). Forman un ecosistema donde el agua circula y los desechos de uno son alimento para el otro.</p>
            
            <h3>2. Relaci√≥n Simbi√≥tica</h3>
            <ul>
                <li><b>Peces:</b> Generan desechos (Amon√≠aco).</li>
                <li><b>Bacterias:</b> Transforman desechos en Nitratos.</li>
                <li><b>Plantas:</b> Absorben Nitratos y limpian el agua para los peces.</li>
            </ul>

            <h3>3. Ciclo del Agua</h3>
            <p>Peces ‚ûî Amon√≠aco ‚ûî Nitritos ‚ûî Nitratos ‚ûî Plantas ‚ûî Agua Limpia ‚ûî Peces.</p>

            <h2>PECES Y SU CUIDADO</h2>
            <h3>1. Tipos de peces</h3>
            <p><b>Tilapia:</b> Muy resistente y crece r√°pido. Ideal para principiantes.<br><b>Carpa y Bagre:</b> Tambi√©n comunes pero requieren cuidados espec√≠ficos.</p>
            
            <h3>2. Par√°metros Vitales</h3>
            <div class="highlight-box">
                pH: 6.5 ‚Äì 7.0<br>
                Temp: 20¬∞C ‚Äì 28¬∞C<br>
                Amon√≠aco: Casi 0
            </div>

            <h2>PLANTAS Y NUTRIENTES</h2>
            <h3>1. ¬øQu√© cultivar?</h3>
            <p>Lechugas, espinacas, albahaca y tomates son excelentes opciones.</p>
            
            <h3>2. Rol de las Ra√≠ces</h3>
            <p>Act√∫an como un filtro fino y superficie para las bacterias.</p>

            <h2>BIOLOG√çA (BACTERIAS)</h2>
            <p>Sin bacterias, el sistema colapsa. Ellas viven en el biofiltro y la grava. Transforman el veneno (amon√≠aco) en comida (nitratos).</p>

            <h2>DISE√ëO T√âCNICO</h2>
            <h3>Componentes Clave:</h3>
            <ul>
                <li><b>Tanque:</b> Donde viven los peces.</li>
                <li><b>Bomba:</b> Mueve el agua hacia arriba.</li>
                <li><b>Filtro Mec√°nico:</b> Atrapa s√≥lidos (heces).</li>
                <li><b>Biofiltro:</b> Hogar de bacterias.</li>
                <li><b>Cama de Cultivo:</b> Soporte para plantas.</li>
            </ul>

            <h2>SUSTENTABILIDAD</h2>
            <p>Ahorra hasta un <b>90% de agua</b> comparado con la agricultura tradicional y produce prote√≠na y vegetales en espacios reducidos.</p>
        </div>
    </div>
</div>

<!-- MODAL IA -->
<div id="modal-ai" class="modal-overlay">
    <div class="modal-box">
        <h2 style="color:#6200ea;" id="ai-title">IA</h2>
        <div id="ai-content">...</div>
        <button class="btn-ai" style="margin: 20px auto; width: auto;" onclick="document.getElementById('modal-ai').style.display='none'">Cerrar</button>
    </div>
</div>

<!-- MODAL VICTORIA -->
<div id="modal-victory" class="modal-overlay">
    <div class="modal-box" style="border: 5px solid gold;">
        <h1 style="color:gold; font-size: 3rem; margin:0;">üèÜ</h1>
        <h2 style="color:#006064;">¬°Felicidades!</h2>
        <p>Has completado el ciclo de vida acuap√≥nico con √©xito.</p>
        <div style="margin: 20px; padding: 20px; border: 2px dashed #00bcd4; background: #e0f7fa; border-radius: 10px;">
            <h3 style="margin-top:0;">CERTIFICADO DE MAESTRO ACUAPONISTA</h3>
            <p style="font-size:0.9rem;">Otorgado por cultivar alimentos de manera sostenible y equilibrada.</p>
        </div>
        <button class="btn-ai" style="margin: 0 auto; border-color:#009688; color:#009688;" onclick="location.reload()">Reiniciar Sistema</button>
    </div>
</div>

<script>
    /* CONFIGURACI√ìN TUBER√çAS (Coordenadas SVG Din√°micas) */
    function updatePipes() {
        const svg = document.querySelector('.pipes-layer');
        const rect = svg.getBoundingClientRect();

        const getCenter = (id) => {
            const el = document.getElementById(id);
            const r = el.getBoundingClientRect();
            return { x: r.left + r.width/2 - rect.left, y: r.top + r.height/2 - rect.top };
        };

        const pPump = getCenter('slot-pump');
        const pMech = getCenter('slot-mech');
        const pBio = getCenter('slot-bio');
        const pBed = getCenter('slot-bed');
        const pTank = getCenter('slot-tank');

        // 1. Bomba -> Mec√°nico (Sube y dobla)
        setPath('path-1', `M ${pPump.x} ${pPump.y} V ${pMech.y} H ${pMech.x}`);
        setPath('flow-1', `M ${pPump.x} ${pPump.y} V ${pMech.y} H ${pMech.x}`);

        // 2. Mec√°nico -> Bio (Horizontal)
        setPath('path-2', `M ${pMech.x} ${pMech.y} H ${pBio.x}`);
        setPath('flow-2', `M ${pMech.x} ${pMech.y} H ${pBio.x}`);

        // 3. Bio -> Cama (Horizontal)
        setPath('path-3', `M ${pBio.x} ${pBio.y} H ${pBed.x}`);
        setPath('flow-3', `M ${pBio.x} ${pBio.y} H ${pBed.x}`);

        // 4. Cama -> Tanque (Sif√≥n: Baja por la derecha y regresa al centro)
        const bedOutX = pBed.x + 100; // Salida por la derecha de la cama
        setPath('path-4', `M ${bedOutX} ${pBed.y} V ${pTank.y - 50} H ${pTank.x + 120} V ${pTank.y}`);
        setPath('flow-4', `M ${bedOutX} ${pBed.y} V ${pTank.y - 50} H ${pTank.x + 120} V ${pTank.y}`);
    }

    function setPath(id, d) { document.getElementById(id).setAttribute('d', d); }
    
    window.addEventListener('resize', updatePipes);
    setTimeout(updatePipes, 500); // Init inicial

    /* L√ìGICA JUEGO Y DRAG & DROP */
    const STATE = { built: {}, chem: { bacteria:0, ammonia:0, ph:7 }, life: { fish:0, plants:0 }, loop: null };
    const draggables = document.querySelectorAll('.draggable-item');
    const dropZones = document.querySelectorAll('.drop-zone');

    draggables.forEach(d => d.addEventListener('dragstart', e => {
        if(!d.classList.contains('locked')) e.dataTransfer.setData('type', d.dataset.type);
    }));

    dropZones.forEach(z => {
        z.addEventListener('dragover', e => { e.preventDefault(); z.classList.add('hovered'); });
        z.addEventListener('dragleave', e => { z.classList.remove('hovered'); });
        z.addEventListener('drop', e => {
            e.preventDefault(); z.classList.remove('hovered');
            handleDrop(z, e.dataTransfer.getData('type'), e.clientX, e.clientY);
        });
    });

    function handleDrop(zone, type, x, y) {
        const accept = zone.dataset.accept.split(',');
        if(!accept.includes(type)) return;

        if(['tank','pump','mech','bio','bed'].includes(type)) {
            if(!STATE.built[type]) {
                STATE.built[type] = 1;
                document.getElementById(`slot-${type}`).classList.add('filled');
                document.getElementById(`obj-${type}`).classList.add('visible');
                document.getElementById(`item-${type}`).style.opacity = '0.3';
                document.getElementById(`item-${type}`).draggable = false;
                showToast("Instalado", x, y, "#333");
                if(Object.keys(STATE.built).length >= 5) updateInstruction("Arrastra las TUBER√çAS para conectar el sistema.");
                setTimeout(updatePipes, 100);
            }
        }
        else if(type === 'pipes') {
            if(STATE.built.tank && STATE.built.pump && STATE.built.mech && STATE.built.bio && STATE.built.bed) {
                STATE.built.pipes = 1;
                document.getElementById('item-pipes').style.display='none';
                document.getElementById('slot-pipes').classList.add('filled');
                document.getElementById('slot-pipes').innerHTML = "";
                document.querySelectorAll('.pipe-path').forEach(p => p.style.stroke = '#546e7a');
                updateInstruction("Ahora a√±ade AGUA para probar el sistema.");
                showToast("Conectado", x, y, "#555");
            } else showToast("Faltan componentes", x, y, "red");
        }
        else if(type === 'water') {
            if(STATE.built.pipes) {
                STATE.built.water = 1;
                document.getElementById('water-tank').style.height = '80%';
                document.getElementById('water-bed').style.height = '60%';
                document.querySelectorAll('.pipe-water').forEach(p => p.style.opacity = 1);
                document.getElementById('item-water').style.display='none';
                document.getElementById('item-ammonia').classList.remove('locked');
                updateInstruction("A√±ade AMON√çACO para iniciar el Ciclado.");
                if(!STATE.loop) STATE.loop = setInterval(simLoop, 1000);
            } else showToast("Faltan tuber√≠as", x, y, "red");
        }
        // L√≥gica Biol√≥gica Simplificada
        else if(type === 'ammonia') { STATE.chem.ammonia += 5; showToast("+5 Amon√≠aco", x, y, "brown"); }
        else if(type === 'fish') { 
            if(STATE.chem.bacteria > 80) { 
                STATE.life.fish = 10; 
                document.getElementById('item-fish').style.display='none';
                document.getElementById('item-plants').classList.remove('locked');
                addFishVisuals();
                updateInstruction("Ahora planta las SEMILLAS.");
            } else showToast("Agua t√≥xica", x, y, "red");
        }
        else if(type === 'plants') {
            STATE.life.plants = 1;
            document.getElementById('item-plants').style.display='none';
            document.getElementById('item-food').classList.remove('locked');
            document.getElementById('item-base').classList.remove('locked');
            addPlantVisuals();
            updateInstruction("Sistema Completo. Alimenta y cuida el pH.");
        }
        else if(type === 'food') { STATE.chem.ammonia += 2; showToast("Alimentado", x, y, "orange"); }
        else if(type === 'base') { STATE.chem.ph += 0.5; showToast("pH +", x, y, "purple"); }
    }

    function simLoop() {
        if(STATE.chem.ammonia > 0 && STATE.chem.bacteria < 100) {
            STATE.chem.bacteria += 2; 
            STATE.chem.ammonia -= 0.1;
            if(STATE.chem.bacteria > 80) document.getElementById('item-fish').classList.remove('locked');
        }
        if(STATE.life.fish > 0) {
            STATE.chem.ammonia += 0.1;
            let clean = STATE.chem.ammonia * (STATE.chem.bacteria/100) * 0.5;
            STATE.chem.ammonia -= clean;
            if(clean > 0) STATE.chem.ph -= 0.002;
        }
        if(STATE.life.plants > 0 && STATE.chem.ph > 6) {
            STATE.life.plants += 0.2;
            if(STATE.life.plants >= 100) {
                STATE.life.plants = 100;
                showVictory();
                clearInterval(STATE.loop);
            }
        }
        
        STATE.chem.ammonia = Math.max(0, STATE.chem.ammonia);
        STATE.chem.ph = Math.max(4, Math.min(10, STATE.chem.ph));
        updateUI();
    }

    function updateUI() {
        document.getElementById('stat-bac').innerText = Math.floor(STATE.chem.bacteria) + "%";
        document.getElementById('stat-amm').innerText = STATE.chem.ammonia.toFixed(1);
        document.getElementById('stat-ph').innerText = STATE.chem.ph.toFixed(1);
        document.getElementById('stat-grow').innerText = Math.floor(STATE.life.plants) + "%";
        
        if(STATE.chem.ammonia > 10) document.getElementById('water-tank').classList.add('dirty');
        else document.getElementById('water-tank').classList.remove('dirty');
        
        if(STATE.life.plants > 0) {
            let s = 10 + STATE.life.plants/2;
            document.querySelectorAll('.plant-mob').forEach(p => p.style.fontSize = s+"px");
        }
    }

    function addFishVisuals() {
        const c = document.getElementById('fish-container');
        for(let i=0; i<5; i++) {
            let f = document.createElement('div'); f.className = 'fish-mob'; f.innerText='üêü';
            f.style.left=Math.random()*80+'%'; f.style.top=Math.random()*80+'%';
            c.appendChild(f);
        }
        setInterval(() => document.querySelectorAll('.fish-mob').forEach(f => {
            f.style.left=Math.random()*80+'%'; f.style.transform=Math.random()>0.5?'scaleX(1)':'scaleX(-1)';
        }), 2000);
    }

    function addPlantVisuals() {
        const c = document.getElementById('plants-container');
        for(let i=0; i<4; i++) {
            let p = document.createElement('div'); p.className='plant-mob'; p.innerText='üå±';
            p.style.left=(20+i*20)+'%'; c.appendChild(p);
        }
    }

    function updateInstruction(t) { document.getElementById('instruction').innerText = t; }
    
    function showToast(m, x, y, c) {
        let t = document.createElement('div'); t.innerText = m; t.className = 'floater';
        t.style.left = x + 'px'; t.style.top = y + 'px'; t.style.color = c;
        document.body.appendChild(t); setTimeout(() => t.remove(), 1500);
    }

    function showVictory() {
        document.getElementById('modal-victory').style.display = 'flex';
    }

    function askAI(mode) {
        document.getElementById('modal-ai').style.display = 'flex';
        document.getElementById('ai-title').innerText = mode==='diagnosis'?'Diagn√≥stico':'Tip';
        document.getElementById('ai-content').innerHTML = mode==='diagnosis' ? 
            `pH: ${STATE.chem.ph.toFixed(1)}<br>Bacteria: ${Math.floor(STATE.chem.bacteria)}%<br><br>${STATE.chem.bacteria<100?'üöß Ciclando...':'‚úÖ Sistema Activo'}` : 
            "üí° Las bacterias nitrosomonas convierten el amon√≠aco en nitritos.";
    }
</script>
</body>
</html>
