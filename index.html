<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Acuapon√≠a Builder V15: Universal</title>
    <style>
        /* ESTILOS GENERALES */
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #eceff1; color: #333; margin: 0; padding: 0; user-select: none; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        /* HEADER */
        header { background: #263238; color: white; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; height: 50px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 20; flex-shrink: 0; }
        h1 { font-size: 1rem; margin: 0; display: flex; align-items: center; gap: 5px; }
        
        .stats-bar { display: flex; gap: 10px; align-items: center; font-size: 0.75rem; overflow-x: auto; white-space: nowrap; padding-left: 10px; }
        .stat-item { background: #37474f; padding: 4px 8px; border-radius: 4px; display: flex; align-items: center; gap: 5px; position: relative;}
        .stat-val { font-weight: bold; color: #4fc3f7; }
        
        /* Barra de vida peces */
        .health-indicator { width: 8px; height: 8px; border-radius: 50%; background: #66bb6a; display: inline-block; margin-right: 3px; }
        .health-low { background: #ef5350; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* LAYOUT PRINCIPAL (3 COLUMNAS PC / FLEX M√ìVIL) */
        .main-layout { display: grid; grid-template-columns: 240px 1fr 350px; flex: 1; overflow: hidden; position: relative; transition: all 0.3s; }
        
        /* 1. INVENTARIO */
        .inventory { background: #fff; border-right: 1px solid #ddd; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; z-index: 10; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        .inv-section { font-weight: bold; color: #0277bd; margin-top: 10px; border-bottom: 2px solid #e1f5fe; padding-bottom: 2px; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .draggable-item { 
            background: #f5f5f5; border: 1px solid #ccc; border-radius: 6px; padding: 8px; 
            cursor: grab; display: flex; align-items: center; gap: 8px; transition: all 0.2s; font-size: 0.85rem;
            touch-action: none; /* Crucial para m√≥viles */
        }
        .draggable-item:hover { transform: translateX(5px); background: #e3f2fd; border-color: #2196f3; }
        .draggable-item:active { cursor: grabbing; transform: scale(0.95); }
        .draggable-item.locked { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); pointer-events: none; }
        .item-icon { font-size: 1.2rem; min-width: 25px; text-align: center; }

        /* GHOST DRAG (Elemento visual al arrastrar en m√≥vil) */
        .drag-ghost {
            position: fixed; pointer-events: none; z-index: 9999; opacity: 0.8;
            background: white; padding: 10px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border: 2px solid #2196f3; transform: translate(-50%, -50%); font-size: 0.9rem; font-weight: bold;
            display: flex; align-items: center; gap: 5px;
        }

        /* 2. ZONA DE CONSTRUCCI√ìN (CENTRO) */
        .workspace { position: relative; background-image: radial-gradient(#cfd8dc 1px, transparent 1px); background-size: 20px 20px; background-color: #eceff1; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        
        /* Contenedor relativo para escalar en m√≥viles */
        .game-board { position: relative; width: 800px; height: 600px; transform-origin: center center; }

        /* Instrucciones Flotantes */
        .instruction-panel {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.90); padding: 6px 15px; border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-weight: bold; color: #006064;
            border: 1px solid #00bcd4; z-index: 50; text-align: center; width: auto; min-width: 300px; font-size: 0.85rem;
            pointer-events: none;
        }

        /* 3. PANEL EDUCATIVO (DERECHA) */
        .edu-sidebar { 
            background: white; border-left: 1px solid #ccc; overflow-y: auto; padding: 0; 
            display: flex; flex-direction: column; box-shadow: -2px 0 5px rgba(0,0,0,0.05);
        }
        
        /* Panel de Control IA */
        .ai-control-panel {
            background: #f3e5f5; padding: 10px; border-bottom: 1px solid #e1bee7;
            position: sticky; top: 0; z-index: 20; display: flex; flex-direction: column; gap: 5px;
        }
        .ai-title { color: #6200ea; font-weight: bold; font-size: 0.8rem; text-transform: uppercase; }
        .ai-buttons { display: flex; gap: 5px; }
        .btn-ai { 
            flex: 1; background: white; border: 1px solid #6200ea; color: #6200ea; 
            padding: 6px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.75rem; 
            transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .btn-ai:hover { background: #6200ea; color: white; }

        /* Manual */
        .manual-content { padding: 15px; font-size: 0.85rem; line-height: 1.5; color: #444; }
        .manual-content h2 { font-size: 1rem; color: #0277bd; border-bottom: 2px solid #b3e5fc; padding-bottom: 5px; margin-top: 20px; margin-bottom: 8px; }
        .manual-content h3 { font-size: 0.9rem; color: #006064; margin-top: 10px; font-weight: bold; }
        .highlight-box { background: #e0f2f1; padding: 10px; border-radius: 5px; border-left: 4px solid #009688; margin: 10px 0; }

        /* SISTEMA DE TUBER√çAS (SVG) */
        .pipes-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .pipe-path { fill: none; stroke: #cfd8dc; stroke-width: 8; stroke-linecap: round; stroke-linejoin: round; transition: stroke 1s; }
        .pipe-water { fill: none; stroke: #4fc3f7; stroke-width: 4; stroke-linecap: round; stroke-dasharray: 10; animation: flow 1s linear infinite; opacity: 0; transition: opacity 1s; }
        @keyframes flow { to { stroke-dashoffset: -20; } }

        /* ZONAS DE CA√çDA (SLOTS) */
        .drop-zone { 
            position: absolute; border: 2px dashed #90a4ae; background: rgba(255,255,255,0.5); 
            border-radius: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center; 
            color: #78909c; font-size: 0.75rem; text-align: center; transition: all 0.3s; z-index: 2;
        }
        .drop-zone.hovered { background: rgba(129, 199, 132, 0.6); border-color: #4caf50; transform: scale(1.05); }
        .drop-zone.filled { border: none; background: transparent; }
        
        .label-tag {
            position: absolute; bottom: -20px; width: 100%; text-align: center;
            background: #333; color: white; padding: 2px 0; font-size: 10px; border-radius: 4px;
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .drop-zone.filled:hover .label-tag { opacity: 1; }

        /* POSICIONES ABSOLUTAS - AJUSTADAS PARA EVITAR OVERLAP */
        /* Bajamos los componentes superiores para que no choquen con el mensaje de instrucciones */
        
        #slot-tank { bottom: 50px; left: 50%; transform: translateX(-50%); width: 300px; height: 150px; }
        
        #slot-bed { top: 130px; right: 50px; width: 250px; height: 120px; } /* Bajado de 50px a 130px */
        
        #slot-mech { top: 180px; left: 50px; width: 90px; height: 120px; } /* Bajado de 100px a 180px */
        #slot-bio { top: 180px; left: 180px; width: 90px; height: 120px; } /* Bajado de 100px a 180px */
        
        #slot-pump { bottom: 70px; left: calc(50% - 120px); width: 40px; height: 40px; z-index: 5; }
        #slot-pipes { top: 60%; left: 50%; transform: translate(-50%, -50%); width: 100px; height: 60px; }

        /* OBJETOS VISUALES */
        .object { width: 100%; height: 100%; position: relative; display: none; cursor: help; }
        .object.visible { display: block; animation: popIn 0.4s ease-out; }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .visual-tank { background: rgba(33, 150, 243, 0.1); border: 3px solid #1976d2; border-radius: 0 0 15px 15px; border-top: none; position: relative; overflow: hidden; }
        .visual-bed { background: #795548; border: 3px solid #4e342e; border-radius: 5px; position: relative; overflow: hidden; }
        .visual-mech { background: #bdbdbd; border: 3px solid #616161; border-radius: 5px 5px 15px 15px; display: flex; align-items: center; justify-content: center; }
        .visual-mech::after { content: "üåÄ"; font-size: 24px; opacity: 0.5; }
        .visual-bio { background: #4db6ac; border: 3px solid #00796b; border-radius: 5px; display: flex; flex-wrap: wrap; align-content: center; justify-content: center; gap: 3px; padding: 5px; }
        .bio-ball { width: 10px; height: 10px; background: #004d40; border-radius: 50%; opacity: 0.3; }
        .visual-pump { background: #263238; border-radius: 50%; border: 2px solid #000; box-shadow: 0 0 5px rgba(0,0,0,0.5); }

        /* AGUA Y VIDA */
        .water-fill { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background: rgba(33, 150, 243, 0.5); transition: height 1.5s ease-in-out; }
        .water-fill.dirty { background: rgba(141, 110, 99, 0.6); }
        
        .fish-mob { position: absolute; font-size: 24px; transition: all 1s; pointer-events: none; }
        .fish-dead { transform: rotate(180deg) !important; filter: grayscale(100%); transition: transform 0.5s; }
        .plant-mob { position: absolute; bottom: 5px; font-size: 0px; transition: font-size 1s; transform-origin: bottom center; }

        /* TOASTS */
        .floater { position: fixed; font-weight: bold; pointer-events: none; animation: floatUp 1.5s ease-out forwards; z-index: 200; text-shadow: 0 0 3px white; font-size: 1.2rem; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }

        /* MODAL COMPARTIDO */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 85%; max-width: 450px; padding: 25px; border-radius: 15px; text-align: center; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; }

        /* --- MEDIA QUERIES PARA M√ìVIL --- */
        @media (max-width: 900px) {
            /* Cambiar layout a columna */
            .main-layout { grid-template-columns: 1fr; grid-template-rows: 1fr auto auto; }
            
            /* Orden: Juego arriba, Inventario abajo */
            .workspace { order: 1; height: 55vh; }
            
            /* Inventario Horizontal Deslizable */
            .inventory { 
                order: 2; width: 100%; height: 120px; flex-direction: row; border-right: none; border-top: 2px solid #ccc;
                overflow-x: auto; overflow-y: hidden; padding: 5px; gap: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            }
            .inv-section { display: none; } /* Ocultar t√≠tulos para ahorrar espacio */
            .draggable-item { 
                min-width: 100px; flex-direction: column; justify-content: center; text-align: center; 
                font-size: 0.75rem; padding: 5px; height: 90%;
            }
            .item-icon { font-size: 1.8rem; display: block; margin-bottom: 2px; }
            .draggable-item:hover { transform: none; } /* Quitar hover en t√°ctil */

            /* Panel Educativo Oculto por defecto o abajo */
            .edu-sidebar { order: 3; height: auto; max-height: 25vh; border-left: none; border-top: 1px solid #ccc; }
            
            /* Ajustar Game Board para que quepa */
            .game-board { transform: scale(0.6); transform-origin: top center; margin-top: 20px; }
            
            /* Ajustar Header */
            h1 { font-size: 0.9rem; }
            .stats-bar { gap: 5px; font-size: 0.7rem; }
        }

        @media (max-width: 480px) {
            .game-board { transform: scale(0.45); }
            .instruction-panel { width: 90%; font-size: 0.8rem; }
        }
        
    </style>
</head>
<body>

<header>
    <h1>üå± Acuapon√≠a <span style="color:#81d4fa;">V15</span></h1>
    <div class="stats-bar">
        <div class="stat-item"><div class="health-indicator" id="ind-health"></div> ‚ù§Ô∏è <span id="stat-health">100%</span></div>
        <div class="stat-item">ü¶† <span id="stat-bac">0%</span></div>
        <div class="stat-item">üß™ <span id="stat-amm">0</span></div>
        <div class="stat-item">üíß <span id="stat-ph">7.0</span></div>
        <div class="stat-item">ü•¨ <span id="stat-grow">0%</span></div>
    </div>
</header>

<div class="main-layout">
    
    <!-- 1. INVENTARIO -->
    <div class="inventory">
        <div class="inv-section">Estructura</div>
        <div class="draggable-item" draggable="true" data-type="tank" id="item-tank"><span class="item-icon">üü¶</span> Tanque</div>
        <div class="draggable-item" draggable="true" data-type="pump" id="item-pump"><span class="item-icon">‚öôÔ∏è</span> Bomba</div>
        <div class="draggable-item" draggable="true" data-type="mech" id="item-mech"><span class="item-icon">üóëÔ∏è</span> Filtro M.</div>
        <div class="draggable-item" draggable="true" data-type="bio" id="item-bio"><span class="item-icon">ü¶†</span> Biofiltro</div>
        <div class="draggable-item" draggable="true" data-type="bed" id="item-bed"><span class="item-icon">üü´</span> Cama</div>
        <div class="draggable-item" draggable="true" data-type="pipes" id="item-pipes"><span class="item-icon">üîß</span> Tuber√≠as</div>
        <div class="draggable-item" draggable="true" data-type="water" id="item-water"><span class="item-icon">üíß</span> Agua</div>

        <div class="inv-section">Biolog√≠a</div>
        <div class="draggable-item locked" draggable="true" data-type="ammonia" id="item-ammonia"><span class="item-icon">üß™</span> Amon√≠aco</div>
        <div class="draggable-item locked" draggable="true" data-type="fish" id="item-fish"><span class="item-icon">üêü</span> Peces</div>
        
        <div class="inv-section">Cultivos</div>
        <div class="draggable-item locked" draggable="true" data-type="lettuce" id="item-lettuce"><span class="item-icon">ü•¨</span> Lechuga</div>
        <div class="draggable-item locked" draggable="true" data-type="tomato" id="item-tomato"><span class="item-icon">üçÖ</span> Tomate</div>
        <div class="draggable-item locked" draggable="true" data-type="berry" id="item-berry"><span class="item-icon">üçì</span> Fresa</div>
        
        <div class="inv-section">Cuidados</div>
        <div class="draggable-item locked" draggable="true" data-type="food" id="item-food"><span class="item-icon">ü¶ê</span> Comida</div>
        <div class="draggable-item locked" draggable="true" data-type="base" id="item-base"><span class="item-icon">üíä</span> Subir pH</div>
        <div class="draggable-item locked" draggable="true" data-type="acid" id="item-acid"><span class="item-icon">üçã</span> Bajar pH</div>
    </div>

    <!-- 2. √ÅREA DE TRABAJO -->
    <div class="workspace" id="workspace">
        <div class="instruction-panel" id="instruction">Construye: Arrastra el TANQUE al centro.</div>
        
        <!-- Contenedor Escalable -->
        <div class="game-board" id="game-board">
            <!-- SVG Tuber√≠as -->
            <svg class="pipes-layer">
                <path id="path-1" class="pipe-path" d="M0 0" /><path id="flow-1" class="pipe-water" d="M0 0" />
                <path id="path-2" class="pipe-path" d="M0 0" /><path id="flow-2" class="pipe-water" d="M0 0" />
                <path id="path-3" class="pipe-path" d="M0 0" /><path id="flow-3" class="pipe-water" d="M0 0" />
                <path id="path-4" class="pipe-path" d="M0 0" /><path id="flow-4" class="pipe-water" d="M0 0" />
            </svg>

            <!-- SLOTS -->
            <div id="slot-tank" class="drop-zone" data-accept="tank,water,ammonia,fish,food,base,acid">üìç Tanque<div class="object visual-tank" id="obj-tank"><div class="water-fill" id="water-tank"></div><div id="fish-container" style="position:absolute; inset:0;"></div><div class="label-tag">Tanque</div></div></div>
            <div id="slot-pump" class="drop-zone" data-accept="pump">‚öôÔ∏è<div class="object visual-pump" id="obj-pump"><div class="label-tag">Bomba</div></div></div>
            <div id="slot-mech" class="drop-zone" data-accept="mech">üóëÔ∏è<div class="object visual-mech" id="obj-mech"><div class="label-tag">Decantador</div></div></div>
            <div id="slot-bio" class="drop-zone" data-accept="bio">ü¶†<div class="object visual-bio" id="obj-bio"><div class="bio-ball"></div><div class="bio-ball"></div><div class="bio-ball"></div><div class="bio-ball"></div><div class="label-tag">Biofiltro</div></div></div>
            <div id="slot-bed" class="drop-zone" data-accept="bed,lettuce,tomato,berry">üü´ Cama<div class="object visual-bed" id="obj-bed"><div class="water-fill" id="water-bed"></div><div id="plants-container" style="position:absolute; bottom:0; width:100%; text-align:center;"></div><div class="label-tag">Cama de Cultivo</div></div></div>
            <div id="slot-pipes" class="drop-zone" data-accept="pipes">üîó<div class="object" id="obj-pipes" style="display:none;"></div></div>
        </div>
    </div>

    <!-- 3. PANEL EDUCATIVO (DERECHA/ABAJO) -->
    <div class="edu-sidebar">
        <div class="ai-control-panel">
            <span class="ai-title">Asistente Inteligente</span>
            <div class="ai-buttons">
                <button class="btn-ai" onclick="askAI('diagnosis')">üîç Diagn√≥stico</button>
                <button class="btn-ai" onclick="askAI('tips')">üí° Tip Experto</button>
            </div>
        </div>
        <div class="manual-content">
            <h2>FUNDAMENTOS DE LA ACUAPON√çA</h2>
            <h3>¬øQu√© es?</h3>
            <p>Un ecosistema vivo que integra la <b>Acuicultura</b> (peces) y la <b>Hidropon√≠a</b> (plantas). Los peces alimentan a las plantas, y las plantas limpian el agua.</p>
            <h3>Ciclo del Nitr√≥geno</h3>
            <p>Peces (Amon√≠aco) ‚ûî Bacterias (Nitratos) ‚ûî Plantas (Comida). ¬°Sin bacterias, el ciclo se rompe!</p>
            <h2>CUIDADO Y PAR√ÅMETROS</h2>
            <div class="highlight-box">
                üå°Ô∏è Temp: 20¬∞C - 28¬∞C<br>
                üß™ pH Ideal: 6.8 - 7.2<br>
                ‚ò†Ô∏è Amon√≠aco: < 1 ppm
            </div>
            <p><b>¬°Cuidado!</b> Si el agua se pone turbia o el pH baja de 6.0, tus peces est√°n en peligro mortal.</p>
        </div>
    </div>
</div>

<!-- MODALES -->
<div id="modal-ai" class="modal-overlay">
    <div class="modal-box">
        <h2 style="color:#6200ea;" id="ai-title">IA</h2>
        <div id="ai-content">...</div>
        <button class="btn-ai" style="margin: 20px auto; width: auto; border:1px solid #ccc;" onclick="document.getElementById('modal-ai').style.display='none'">Cerrar</button>
    </div>
</div>

<div id="modal-victory" class="modal-overlay">
    <div class="modal-box" style="border: 5px solid gold;">
        <h1 style="color:gold; font-size: 3rem; margin:0;">üèÜ</h1>
        <h2 style="color:#006064;">¬°COSECHA EXITOSA!</h2>
        <p>Has completado el ciclo biol√≥gico manteniendo el equilibrio perfecto.</p>
        <div style="margin: 20px; padding: 20px; border: 2px dashed #00bcd4; background: #e0f7fa; border-radius: 10px;">
            <h3 style="margin-top:0;">CERTIFICADO DE MAESTRO ACUAPONISTA</h3>
            <p style="font-size:0.9rem;">Otorgado por excelencia en bioseguridad y producci√≥n sostenible.</p>
        </div>
        <button class="btn-ai" style="margin: 0 auto; border-color:#009688; color:#009688;" onclick="location.reload()">Reiniciar</button>
    </div>
</div>

<div id="modal-gameover" class="modal-overlay">
    <div class="modal-box" style="border: 5px solid #ef5350;">
        <h1 style="font-size: 3rem; margin:0;">‚ò†Ô∏è</h1>
        <h2 style="color:#c62828;">Tus peces han muerto</h2>
        <p id="death-reason">Causa desconocida.</p>
        <button class="btn-ai" style="margin: 20px auto; background:#ef5350; color:white;" onclick="location.reload()">Reintentar</button>
    </div>
</div>

<script>
    /* LOGICA ADAPTATIVA */
    // Ajustar zoom del tablero en resize
    function resizeBoard() {
        const board = document.getElementById('game-board');
        const container = document.getElementById('workspace');
        if(window.innerWidth < 900) {
            // Calcular escala para que quepa
            let scale = Math.min(container.clientWidth / 850, container.clientHeight / 650);
            board.style.transform = `scale(${scale})`;
        } else {
            board.style.transform = 'scale(1)';
        }
    }
    window.addEventListener('resize', () => { resizeBoard(); updatePipes(); });
    setTimeout(resizeBoard, 100);

    /* L√ìGICA TUBER√çAS */
    function updatePipes() {
        const getCenter = (id) => {
            const el = document.getElementById(id);
            const r = el.getBoundingClientRect(); // Coordenadas globales
            const svgRect = document.querySelector('.pipes-layer').getBoundingClientRect();
            // Convertir a coordenadas relativas al SVG (que est√° dentro del game-board transformado)
            // Esto es truco: en scale transform, SVG coords son relativas al sistema sin escala.
            // Mejor usar offsets relativos al board.
            const board = document.getElementById('game-board');
            const boardRect = board.getBoundingClientRect();
            
            // Posici√≥n relativa al board (0-800, 0-600)
            // offsetLeft no funciona bien con transform. Usamos coordenadas relativas manuales.
            // Hardcoded positions based on CSS to ensure stability in zoom
            return getPosFromCSS(id);
        };

        // Coordenadas "l√≥gicas" (sin escala) basadas en el CSS del tablero
        // AJUSTADO: Coordenadas nuevas para filtros y camas bajados
        const pPump = {x: 280, y: 550}; // bottom 70, left calc(50%-120) = 400-120=280
        const pMech = {x: 95, y: 240}; // top 180, left 50 + center(45) -> ~95
        const pBio = {x: 225, y: 240}; // top 180, left 180 + center(45) -> ~225
        const pBed = {x: 675, y: 190}; // top 130, right 50 (750), width 250 (center +125) -> Wait right 50 is at x=550. No, 800-50-250 = 500 start x. Center is 625.
        // Let's recheck pBed css: right: 50px, width: 250px.
        // Left = 800 - 50 - 250 = 500. Center X = 500 + 125 = 625.
        // Top = 130. Height 120. Center Y = 130 + 60 = 190.
        const pTank = {x: 400, y: 525}; // bottom 50, width 300. Center X 400. Top 600-50-150 = 400. Center Y 400 + 75 = 475. 
        // Wait tank is bottom 50, height 150.
        // Y pos: 600 - 50 - 150/2 = 475. 
        // Let's keep pTank at typical pipe entry level.

        setPath('path-1', `M ${pPump.x} ${pPump.y} V ${pMech.y} H ${pMech.x}`); setPath('flow-1', `M ${pPump.x} ${pPump.y} V ${pMech.y} H ${pMech.x}`);
        setPath('path-2', `M ${pMech.x} ${pMech.y} H ${pBio.x}`); setPath('flow-2', `M ${pMech.x} ${pMech.y} H ${pBio.x}`);
        setPath('path-3', `M ${pBio.x} ${pBio.y} H ${pBed.x}`); setPath('flow-3', `M ${pBio.x} ${pBio.y} H ${pBed.x}`);
        const bedOutX = pBed.x + 100;
        setPath('path-4', `M ${bedOutX} ${pBed.y} V ${pTank.y - 50} H ${pTank.x + 120} V ${pTank.y}`); setPath('flow-4', `M ${bedOutX} ${pBed.y} V ${pTank.y - 50} H ${pTank.x + 120} V ${pTank.y}`);
    }
    function getPosFromCSS(id) { 
        // Simplificaci√≥n: Usar coordenadas est√°ticas pre-calculadas para estabilidad
        // ya que el drag and drop usa CSS fijo en el board
        if(id=='slot-pump') return {x: 300, y: 550}; // Approx
        if(id=='slot-mech') return {x: 95, y: 240}; // Adjusted
        if(id=='slot-bio') return {x: 225, y: 240}; // Adjusted
        if(id=='slot-bed') return {x: 625, y: 190}; // Adjusted
        if(id=='slot-tank') return {x: 400, y: 500}; // Approx
        return {x:0, y:0};
    }
    function setPath(id, d) { document.getElementById(id).setAttribute('d', d); }
    setTimeout(updatePipes, 500);

    /* JUEGO */
    const STATE = { built: {}, chem: { bacteria:0, ammonia:0, ph:7 }, life: { fish:0, health:100, plants:0, plantType:null }, loop: null, gameOver:false };
    const PLANT_DATA = { lettuce: { name: "Lechuga", growthRate: 0.3, icon: "ü•¨" }, tomato: { name: "Tomate", growthRate: 0.15, icon: "üçÖ" }, berry: { name: "Fresa", growthRate: 0.1, icon: "üçì" } };

    /* DRAG & DROP + TOUCH SUPPORT */
    const draggables = document.querySelectorAll('.draggable-item');
    const dropZones = document.querySelectorAll('.drop-zone');

    // Soporte PC
    draggables.forEach(d => d.addEventListener('dragstart', e => { 
        if(!d.classList.contains('locked')) e.dataTransfer.setData('type', d.dataset.type); 
    }));
    dropZones.forEach(z => {
        z.addEventListener('dragover', e => { e.preventDefault(); z.classList.add('hovered'); });
        z.addEventListener('dragleave', e => { z.classList.remove('hovered'); });
        z.addEventListener('drop', e => { 
            e.preventDefault(); z.classList.remove('hovered'); 
            handleAction(z, e.dataTransfer.getData('type'), e.clientX, e.clientY); 
        });
    });

    // Soporte T√ÅCTIL (M√≥vil)
    let activeTouchItem = null;
    let ghostEl = null;

    draggables.forEach(d => {
        d.addEventListener('touchstart', e => {
            if(d.classList.contains('locked')) return;
            e.preventDefault(); // Evitar scroll
            activeTouchItem = d;
            
            // Crear fantasma visual
            ghostEl = d.cloneNode(true);
            ghostEl.classList.add('drag-ghost');
            document.body.appendChild(ghostEl);
            
            moveGhost(e.touches[0]);
        });
        
        d.addEventListener('touchmove', e => {
            if(!activeTouchItem) return;
            e.preventDefault();
            moveGhost(e.touches[0]);
        });

        d.addEventListener('touchend', e => {
            if(!activeTouchItem) return;
            
            // Detectar drop zone
            const touch = e.changedTouches[0];
            // Ocultar ghost moment√°neamente para ver qu√© hay debajo
            ghostEl.style.display = 'none';
            const elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            ghostEl.style.display = 'flex';
            
            const zone = elemBelow ? elemBelow.closest('.drop-zone') : null;
            
            if(zone) {
                handleAction(zone, activeTouchItem.dataset.type, touch.clientX, touch.clientY);
                zone.classList.remove('hovered');
            }

            // Limpieza
            if(ghostEl) ghostEl.remove();
            activeTouchItem = null;
            ghostEl = null;
        });
    });

    function moveGhost(touch) {
        if(ghostEl) {
            ghostEl.style.left = touch.clientX + 'px';
            ghostEl.style.top = touch.clientY + 'px';
        }
    }

    /* MANEJO DE ACCIONES (Unificado para PC y M√≥vil) */
    function handleAction(zone, type, x, y) {
        if(STATE.gameOver) return;
        const accept = zone.dataset.accept.split(',');
        if(!accept.includes(type)) return;

        // Construcci√≥n
        if(['tank','pump','mech','bio','bed'].includes(type)) {
            if(!STATE.built[type]) {
                STATE.built[type] = 1;
                document.getElementById(`slot-${type}`).classList.add('filled');
                document.getElementById(`obj-${type}`).classList.add('visible');
                document.getElementById(`item-${type}`).style.opacity = '0.3';
                document.getElementById(`item-${type}`).draggable = false;
                document.getElementById(`item-${type}`).classList.add('locked'); // Lock visuals
                if(Object.keys(STATE.built).length >= 5) updateInstruction("Arrastra las TUBER√çAS para conectar.");
                setTimeout(updatePipes, 100);
            }
        }
        else if(type === 'pipes') {
            if(Object.keys(STATE.built).length >= 5) {
                STATE.built.pipes = 1;
                document.getElementById('item-pipes').style.display='none';
                document.getElementById('slot-pipes').classList.add('filled');
                document.getElementById('slot-pipes').innerHTML = "";
                document.querySelectorAll('.pipe-path').forEach(p => p.style.stroke = '#546e7a');
                updateInstruction("A√±ade AGUA al tanque.");
            } else showToast("Faltan componentes", x, y, "red");
        }
        else if(type === 'water') {
            if(STATE.built.pipes) {
                STATE.built.water = 1;
                document.getElementById('water-tank').style.height = '80%';
                document.getElementById('water-bed').style.height = '60%';
                document.querySelectorAll('.pipe-water').forEach(p => p.style.opacity = 1);
                document.getElementById('item-water').style.display='none';
                document.getElementById('item-ammonia').classList.remove('locked');
                updateInstruction("Usa AMON√çACO para ciclar el sistema.");
                if(!STATE.loop) STATE.loop = setInterval(simLoop, 1000);
            } else showToast("Faltan tuber√≠as", x, y, "red");
        }
        // Biolog√≠a
        else if(type === 'ammonia') { STATE.chem.ammonia += 5; showToast("+5 Amon√≠aco", x, y, "brown"); }
        else if(type === 'fish') {
            if(STATE.chem.bacteria > 80) {
                STATE.life.fish = 10;
                document.getElementById('item-fish').style.display='none';
                unlock('lettuce'); unlock('tomato'); unlock('berry');
                addFishVisuals();
                updateInstruction("Elige un cultivo y siembra.");
            } else showToast("Agua t√≥xica. Espera ciclado.", x, y, "red");
        }
        else if(['lettuce','tomato','berry'].includes(type)) {
            STATE.life.plants = 1;
            STATE.life.plantType = type;
            document.getElementById('item-lettuce').parentElement.style.display='none'; 
            unlock('food'); unlock('base'); unlock('acid');
            addPlantVisuals(type);
            updateInstruction(`Cultivando ${PLANT_DATA[type].name}. Cuida a los peces.`);
        }
        else if(type === 'food') { STATE.chem.ammonia += 2; showToast("Alimentado", x, y, "orange"); }
        else if(type === 'base') { STATE.chem.ph += 0.5; showToast("pH +", x, y, "purple"); }
        else if(type === 'acid') { STATE.chem.ph -= 0.5; showToast("pH -", x, y, "orange"); }
    }

    function simLoop() {
        if(STATE.gameOver) return;
        // Ciclado
        if(STATE.chem.ammonia > 0 && STATE.chem.bacteria < 100) {
            STATE.chem.bacteria += 2.0; STATE.chem.ammonia -= 0.1;
            if(STATE.chem.bacteria > 80) unlock('fish');
        }
        // Peces
        if(STATE.life.fish > 0) {
            STATE.chem.ammonia += 0.1; 
            if(STATE.chem.ammonia > 5 || STATE.chem.ph < 6.0 || STATE.chem.ph > 8.0) STATE.life.health -= 2;
            else if(STATE.life.health < 100) STATE.life.health += 0.5;

            if(STATE.life.health <= 0) { triggerGameOver(STATE.chem.ammonia > 5 ? "Intoxicaci√≥n por Amon√≠aco" : "pH Letal"); return; }

            let clean = STATE.chem.ammonia * (STATE.chem.bacteria/100) * 0.5;
            STATE.chem.ammonia -= clean;
            if(clean > 0) STATE.chem.ph -= 0.002;
        }
        // Plantas
        if(STATE.life.plants > 0 && STATE.life.plantType) {
            if(STATE.chem.ph > 6 && STATE.chem.ph < 7.5 && STATE.life.health > 50) {
                STATE.life.plants += PLANT_DATA[STATE.life.plantType].growthRate;
            }
            if(STATE.life.plants >= 100) {
                STATE.life.plants = 100;
                document.getElementById('modal-victory').style.display = 'flex';
                STATE.gameOver = true;
            }
        }
        STATE.chem.ammonia = Math.max(0, STATE.chem.ammonia);
        updateUI();
    }

    function updateUI() {
        document.getElementById('stat-bac').innerText = Math.floor(STATE.chem.bacteria) + "%";
        document.getElementById('stat-amm').innerText = STATE.chem.ammonia.toFixed(1);
        document.getElementById('stat-ph').innerText = STATE.chem.ph.toFixed(1);
        document.getElementById('stat-grow').innerText = Math.floor(STATE.life.plants) + "%";
        document.getElementById('stat-health').innerText = Math.floor(STATE.life.health) + "%";
        
        let ind = document.getElementById('ind-health');
        if(STATE.life.health < 50) ind.classList.add('health-low'); else ind.classList.remove('health-low');
        if(STATE.chem.ammonia > 10) document.getElementById('water-tank').classList.add('dirty'); else document.getElementById('water-tank').classList.remove('dirty');

        if(STATE.life.plants > 0) {
            let size = 10 + STATE.life.plants/2;
            let icon = PLANT_DATA[STATE.life.plantType].icon;
            document.querySelectorAll('.plant-mob').forEach(p => { p.style.fontSize = size+"px"; p.innerText = icon; });
        }
    }

    function addFishVisuals() {
        const c = document.getElementById('fish-container');
        for(let i=0; i<5; i++) {
            let f = document.createElement('div'); f.className = 'fish-mob'; f.innerText='üêü';
            f.style.left=Math.random()*80+'%'; f.style.top=Math.random()*80+'%';
            c.appendChild(f);
        }
        setInterval(() => {
            if(STATE.life.health > 0) document.querySelectorAll('.fish-mob').forEach(f => {
                f.style.left=Math.random()*80+'%'; f.style.transform=Math.random()>0.5?'scaleX(1)':'scaleX(-1)';
            });
        }, 2000);
    }

    function addPlantVisuals(type) {
        const c = document.getElementById('plants-container');
        let icon = PLANT_DATA[type].icon;
        for(let i=0; i<4; i++) {
            let p = document.createElement('div'); p.className='plant-mob'; p.innerText=icon;
            p.style.left=(20+i*20)+'%'; c.appendChild(p);
        }
    }

    function triggerGameOver(reason) {
        STATE.gameOver = true;
        document.getElementById('death-reason').innerText = "Causa: " + reason;
        document.getElementById('modal-gameover').style.display = 'flex';
        document.querySelectorAll('.fish-mob').forEach(f => f.classList.add('fish-dead'));
    }

    function updateInstruction(t) { document.getElementById('instruction').innerText = t; }
    function unlock(id) { document.getElementById('item-'+id).classList.remove('locked'); }
    function showToast(m, x, y, c) {
        let t = document.createElement('div'); t.innerText = m; t.className = 'floater';
        t.style.left = x + 'px'; t.style.top = y + 'px'; t.style.color = c;
        document.body.appendChild(t); setTimeout(() => t.remove(), 1500);
    }

    function askAI(mode) {
        document.getElementById('modal-ai').style.display = 'flex';
        document.getElementById('ai-title').innerText = mode==='diagnosis'?'Diagn√≥stico':'Tip';
        let msg = "";
        if(mode === 'diagnosis') {
            msg = `<b>Salud: ${Math.floor(STATE.life.health)}%</b><br>pH: ${STATE.chem.ph.toFixed(1)} | NH3: ${STATE.chem.ammonia.toFixed(1)}<br><br>`;
            if(STATE.life.health < 50) msg += "‚ö†Ô∏è <b>CR√çTICO:</b> Peces muriendo. Revisa pH y Amon√≠aco.";
            else if(STATE.chem.ammonia > 4) msg += "‚ö†Ô∏è <b>ALERTA:</b> Amon√≠aco subiendo. Deja de alimentar.";
            else msg += "‚úÖ Sistema Estable.";
        } else {
            msg = "üí° <b>Tip:</b> Las bacterias necesitan oscuridad. Evita que la luz solar d√© directo al biofiltro.";
        }
        document.getElementById('ai-content').innerHTML = msg;
    }
</script>
</body>
</html>
